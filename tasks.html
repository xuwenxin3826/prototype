<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理 - 机器人后台管理平台</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        :root {
            --primary-color: #1890ff;
            --primary-light: #e6f7ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #f5222d;
            --info-color: #1890ff;
            --bg-color: #f0f2f5;
            --sidebar-bg: #001529;
            --header-bg: #fff;
            --card-bg: #fff;
            --text-primary: #000000e0;
            --text-secondary: #000000a6;
            --border-color: #f0f0f0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* 侧边栏样式 - 保持不变 */
        .sidebar {
            width: 256px;
            background-color: var(--sidebar-bg);
            color: rgba(255, 255, 255, 0.85);
            transition: all 0.3s;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo i {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .nav-menu {
            padding: 16px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.65);
            text-decoration: none;
        }
        
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .nav-item i {
            font-size: 16px;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        
        /* 子菜单样式 - 保持不变 */
        .nav-item-wrapper {
            margin-bottom: 4px;
        }
        
        .nav-item {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.65);
        }
        
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
       
        
        .arrow-icon {
            margin-left: auto;
            font-size: 12px;
            transition: transform 0.3s;
            opacity: 0.7;
        }
        
        .arrow-icon.rotated {
            transform: rotate(180deg);
        }
        
        .sub-nav-menu {
            background-color: rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        
        .nav-item.sub-item {
            padding: 10px 24px 10px 48px;
            font-size: 13px;
            border-left: 2px solid transparent;
            margin-left: 0;
        }
        
        .nav-item.sub-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: white;
            border-left-color: rgba(255, 255, 255, 0.3);
        }
        
        .nav-item.sub-item.active {
            background-color: rgba(24, 144, 255, 0.25);
            color: #fff;
            border-left-color: var(--primary-color);
            font-weight: 500;
        }
        
        .nav-item.sub-item i {
            font-size: 14px;
            width: 18px;
            margin-right: 8px;
        }
        
        /* 主内容区样式 - 保持不变 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            height: 64px;
            background-color: var(--header-bg);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 9;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .content-wrapper {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        /* 卡片样式 - 保持不变 */
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-body {
            padding: 24px;
        }
        
        /* 状态标签样式 - 扩展以支持更多状态 */
        .status-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending { background-color: #fff7e6; color: #fa8c16; }
        .status-ready { background-color: #e6f7ff; color: #1890ff; }
        .status-executing { background-color: #f6ffed; color: #52c41a; }
        .status-paused { background-color: #fffbe6; color: #faad14; }
        .status-completed { background-color: #f6ffed; color: #52c41a; }
        .status-cancelled { background-color: #fff1f0; color: #ff4d4f; }
        .status-aborted { background-color: #fff1f0; color: #ff4d4f; }
        .status-disabled { background-color: #f5f5f5; color: #999; }
        .status-risk { background-color: #fff7e6; color: #ff7c2a; border: 1px solid #ff7c2a; }
        .status-high-risk { background-color: #fff1f0; color: #ff4d4f; border: 1px solid #ff4d4f; }
        
        /* 表格样式 */
        .el-table {
            font-size: 14px;
        }
        
        .el-table .cell {
            line-height: 1.5;
        }
        
        /* 步骤进度样式 */
        .step-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #d9d9d9;
        }
        
        .step-dot.completed { background-color: var(--success-color); }
        .step-dot.executing { 
            background-color: var(--primary-color); 
            animation: pulse 1.5s infinite; 
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* 任务详情样式 */
        .task-detail-section {
            margin-bottom: 24px;
        }
        
        .task-detail-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .task-detail-content {
            background-color: #fafafa;
            border-radius: 6px;
            padding: 16px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 12px;
        }
        
        .detail-label {
            width: 120px;
            color: var(--text-secondary);
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .detail-value {
            flex: 1;
            color: var(--text-primary);
        }
        
        /* 步骤列表样式 */
        .step-list {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .step-item {
            border-bottom: 1px solid var(--border-color);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .step-item:last-child {
            border-bottom: none;
        }
        
        .step-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .step-index {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .step-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Cron帮助对话框样式 */
        .cron-help-dialog .el-message-box__content {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .cron-help-dialog code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #e74c3c;
        }
        
        /* 步骤预览项 */
        .step-preview-item {
            transition: all 0.3s;
        }
        
        .step-preview-item:hover {
            background-color: #f0f9ff;
        }
        
        /* 字段提示 */
        .field-hint {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        /* 统计卡片样式 */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .stat-icon.blue { background-color: #e6f7ff; color: #1890ff; }
        .stat-icon.green { background-color: #f6ffed; color: #52c41a; }
        .stat-icon.orange { background-color: #fff7e6; color: #fa8c16; }
        .stat-icon.red { background-color: #fff1f0; color: #ff4d4f; }
        
        .stat-info {
            flex: 1;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* 异常任务特殊样式 */
        .abnormal-alert {
            margin-bottom: 20px;
        }
        
        .abnormal-task-row {
            background-color: #fff1f0 !important;
        }
        
        .abnormal-task-row:hover {
            background-color: #ffccc7 !important;
        }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 响应式设计 - 保持不变 */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }
            
            .logo-text, .nav-text, .arrow-icon {
                display: none;
            }
            
            .nav-item {
                justify-content: center;
                padding: 16px 0;
            }
            
            .nav-item i {
                margin-right: 0;
                font-size: 20px;
            }
            
            .sub-nav-menu {
                display: none !important;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 拖拽样式 - 关键修复 */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e6f7ff !important;
            border: 2px dashed #1890ff !important;
        }
        
        .sortable-drag {
            opacity: 0.9;
            background-color: #fff !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        .drag-handle {
            cursor: move !important;
            color: #999;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            user-select: none !important;
            -webkit-user-select: none !important;
        }
        
        .drag-handle:hover {
            color: #1890ff;
            background-color: #f0f0f0;
        }
        
        .drag-enabled {
            background-color: #e6f7ff;
            color: #1890ff;
        }
        
        .sortable-drag * {
            user-select: none !important;
        }
        
        .queue-position {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #1890ff;
            color: white;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .stopped-task-row {
            background-color: #f5f5f5 !important;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="dashboard-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <span class="logo-text">机器人后台管理平台</span>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-item" style="text-decoration: none;">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">首页</span>
                </a>
                
                <!-- 任务管理 - 包含子菜单 -->
                <div class="nav-item-wrapper">
                    <div 
                        class="nav-item active" 
                        :class="{ 
                            'active-parent': ['templates', 'tasks', 'scheduling', 'abnormal'].includes(activeNav),
                            'expanded': expandedMenu === 'taskManagement'
                        }"
                        @click="toggleMenu('taskManagement')"
                    >
                        <i class="fas fa-tasks"></i>
                        <span class="nav-text">任务管理</span>
                        <i 
                            class="fas fa-chevron-down arrow-icon" 
                            :class="{ 'rotated': expandedMenu === 'taskManagement' }"
                        ></i>
                    </div>
                    
                    <div class="sub-nav-menu" v-show="expandedMenu === 'taskManagement'">
                        <div 
                            class="nav-item sub-item" 
                            :class="{ active: activeNav === 'templates' }"
                            @click.stop="switchNav('templates')"
                        >
                            <i class="fas fa-clipboard-list"></i>
                            <span class="nav-text">模板管理</span>
                        </div>
                        
                        <div 
                            class="nav-item sub-item" 
                            :class="{ active: activeNav === 'tasks' }"
                            @click.stop="switchNav('tasks')"
                        >
                            <i class="fas fa-list-ul"></i>
                            <span class="nav-text">任务列表</span>
                        </div>
                        
                        <div 
                            class="nav-item sub-item" 
                            :class="{ active: activeNav === 'scheduling' }"
                            @click.stop="switchNav('scheduling')"
                        >
                            <i class="fas fa-calendar-alt"></i>
                            <span class="nav-text">计划管理</span>
                        </div>
                        
                        <div 
                            class="nav-item sub-item" 
                            :class="{ active: activeNav === 'abnormal' }"
                            @click.stop="switchNav('abnormal')"
                        >
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="nav-text">异常处理</span>
                            <span v-if="highRiskTasks.length > 0" style="margin-left: auto; background: #ff4d4f; color: white; border-radius: 10px; padding: 0 6px; font-size: 12px; min-width: 18px; text-align: center;">
                                {{ highRiskTasks.length }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- 机器人管理 -->
                <a href="robots.html" class="nav-item" style="text-decoration: none;">
                    <i class="fas fa-robot"></i>
                    <span class="nav-text">机器人管理</span>
                </a>
                
                <!-- 交互应用管理 -->
                <div class="nav-item-wrapper">
                    <div
                        class="nav-item"
                        :class="{ 'active-parent': expandedMenu === 'appManagement', 'expanded': expandedMenu === 'appManagement' }"
                        @click="toggleMenu('appManagement')"
                    >
                        <i class="fas fa-cogs"></i>
                        <span class="nav-text">交互应用管理</span>
                        <i
                            class="fas fa-chevron-down arrow-icon"
                            :class="{ 'rotated': expandedMenu === 'appManagement' }"
                        ></i>
                    </div>

                    <div class="sub-nav-menu" v-show="expandedMenu === 'appManagement'">
                        <a href="app.html#appLibrary" class="nav-item sub-item">
                            <i class="fas fa-th"></i>
                            <span class="nav-text">应用库管理</span>
                        </a>
                        <a href="app.html#appConfig" class="nav-item sub-item">
                            <i class="fas fa-sliders-h"></i>
                            <span class="nav-text">应用配置管理</span>
                        </a>
                        <a href="app.html#appUpdate" class="nav-item sub-item">
                            <i class="fas fa-sync-alt"></i>
                            <span class="nav-text">应用更新管理</span>
                        </a>
                        <!-- 新增交互历史列表菜单项 -->
                    <a href="app.html#interactionHistory" class="nav-item sub-item"
                       :class="{ active: activeNav === 'interactionHistory' }" @click="setActiveNav('interactionHistory')">
                        <i class="fas fa-history"></i>
                        <span class="nav-text">交互历史列表</span>
                    </a>
                    </div>
                </div>
                
                <!-- 模式管理 -->
                <div class="nav-item-wrapper">
                    <div
                         class="nav-item"
                        :class="{ 
                            'active-parent': expandedMenu === 'modeManagement', 
                            'expanded': expandedMenu === 'modeManagement' 
                          }"
                          @click="toggleMenu('modeManagement')"
                     >
                     <i class="fas fa-cogs"></i>
                     <span class="nav-text">模式管理</span>
                     <i
                        class="fas fa-chevron-down arrow-icon"
                        :class="{ 'rotated': expandedMenu === 'modeManagement' }"
                     ></i>
                </div>

                 <div class="sub-nav-menu" v-show="expandedMenu === 'modeManagement'">
                    <a href="mode.html#switch" class="nav-item sub-item"
                        :class="{ active: activeNav === 'switch' }" @click="setActiveNav('switch')">
                        <i class="fas fa-exchange-alt"></i>
                        <span class="nav-text">模式切换</span>
                    </a>
                    <a href="mode.html#schedule" class="nav-item sub-item"
                        :class="{ active: activeNav === 'schedule' }" @click="setActiveNav('schedule')">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="nav-text">模式排程</span>
                    </a>
                    <a href="mode.html#history" class="nav-item sub-item"
                        :class="{ active: activeNav === 'history' }" @click="setActiveNav('history')">
                        <i class="fas fa-history"></i>
                       <span class="nav-text">历史记录</span>
                    </a>
                    <a href="mode.html#quick" class="nav-item sub-item"
                       :class="{ active: activeNav === 'quick' }" @click="setActiveNav('quick')">
                       <i class="fas fa-bolt"></i>
                       <span class="nav-text">快速操作</span>
                     </a>
                    <a href="mode.html#edit" class="nav-item sub-item"
                      :class="{ active: activeNav === 'edit' }" @click="setActiveNav('edit')">
                      <i class="fas fa-edit"></i>
                      <span class="nav-text">编辑模式</span>
                    </a>
              </div>
         </div>

                <!-- 数据管理与分析 -->
                <div class="nav-item-wrapper">
                    <div 
                        class="nav-item" 
                        :class="{ 
                            'active-parent': ['data-management', 'data-dashboard', 'metrics-analysis', 'ai-analysis'].includes(activeNav),
                            expanded: expandedMenu === 'dataAnalysis'
                        }"
                        @click="toggleMenu('dataAnalysis')"
                    >
                        <i class="fas fa-chart-line"></i>
                        <span class="nav-text">数据管理与分析</span>
                        <i 
                            class="fas fa-chevron-down arrow-icon" 
                            :class="{ 'rotated': expandedMenu === 'dataAnalysis' }"
                        ></i>
                    </div>
                    
                    <div class="sub-nav-menu" v-show="expandedMenu === 'dataAnalysis'">
                        <a href="data.html#tools" class="nav-item sub-item">
                            <i class="fas fa-database"></i>
                            <span class="nav-text">数据管理工具</span>
                        </a>
                        <a href="data.html" class="nav-item sub-item">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="nav-text">数据仪表盘</span>
                        </a>
                        <a href="data.html#metrics" class="nav-item sub-item">
                            <i class="fas fa-chart-bar"></i>
                            <span class="nav-text">指标分析</span>
                        </a>
                        <a href="data.html#ai" class="nav-item sub-item">
                            <i class="fas fa-brain"></i>
                            <span class="nav-text">AI分析</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 顶部导航栏 -->
            <div class="header">
                <div class="header-left">
                    <span class="header-title">{{ getPageTitle() }}</span>
                </div>
                
                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar">A</div>
                        <span>管理员</span>
                    </div>
                </div>
            </div>
            
            <!-- 内容区 -->
            <div class="content-wrapper">
                
                <!-- 1. 模板管理页面 -->
                <div v-if="activeNav === 'templates'" class="template-management-page">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">模板管理</div>
                            <div>
                                <el-button type="primary" @click="showTemplateDialog('create')">
                                    <i class="fas fa-plus"></i> 新增模板
                                </el-button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- 筛选区 -->
                            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                                <el-input 
                                    v-model="templateFilter.keyword" 
                                    placeholder="搜索模板名称" 
                                    style="width: 300px;"
                                    clearable
                                    @change="filterTemplates"
                                >
                                    <template #prefix>
                                        <i class="fas fa-search"></i>
                                    </template>
                                </el-input>
                                
                                <el-select 
                                    v-model="templateFilter.robotGroup" 
                                    placeholder="选择机器人组" 
                                    clearable
                                    @change="filterTemplates"
                                    style="width: 200px;"
                                >
                                    <el-option 
                                        v-for="group in robotGroups" 
                                        :key="group.id" 
                                        :label="group.name" 
                                        :value="group.id"
                                    ></el-option>
                                </el-select>
                                
                                <el-button @click="resetTemplateFilter" style="margin-left: auto;">
                                    <i class="fas fa-undo" style="margin-right: 6px;"></i>重置筛选
                                </el-button>
                            </div>
                            
                            <!-- 模板列表 -->
                            <el-table :data="filteredTemplates" style="width: 100%">
                                <el-table-column prop="name" label="模板名称" width="200"></el-table-column>
                                <el-table-column prop="description" label="模板描述" min-width="200"></el-table-column>
                                <el-table-column label="适用机器人组" width="180">
                                    <template #default="scope">
                                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                            <el-tag 
                                                v-for="groupId in scope.row.robotGroupIds" 
                                                :key="groupId" 
                                                size="small"
                                                type="info"
                                            >
                                                {{ getRobotGroupName(groupId) }}
                                            </el-tag>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="字段数量" width="100" align="center">
                                    <template #default="scope">
                                        <el-tag size="small" type="success">{{ scope.row.fields.length }}</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="步骤数量" width="100" align="center">
                                    <template #default="scope">
                                        <el-tag size="small" type="warning">{{ scope.row.steps.length }}</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200" fixed="right">
                                    <template #default="scope">
                                        <el-button size="small" @click="viewTemplate(scope.row)">查看</el-button>
                                        <el-button size="small" type="primary" @click="showTemplateDialog('edit', scope.row)">修改</el-button>
                                        <el-button size="small" type="danger" @click="deleteTemplate(scope.row.id)">删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </div>
                </div>
                
                <!-- 2. 任务列表页面 -->
                <div v-if="activeNav === 'tasks'" class="task-management-page">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">任务管理</div>
                            <div>
                                <el-button type="primary" @click="showTaskDialog('process')">
                                    <i class="fas fa-plus"></i> 创建完整流程任务
                                </el-button>
                                <el-button type="primary" plain @click="showTaskDialog('simple')">
                                    <i class="fas fa-plus"></i> 创建简单动作任务
                                </el-button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- 筛选区 -->
                            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <el-input 
                                    v-model="taskFilter.keyword" 
                                    placeholder="搜索任务名称" 
                                    style="width: 280px;"
                                    clearable
                                    @change="filterTasks"
                                >
                                    <template #prefix>
                                        <i class="fas fa-search"></i>
                                    </template>
                                </el-input>
                                
                                <el-select 
                                    v-model="taskFilter.status" 
                                    placeholder="选择任务状态" 
                                    clearable
                                    @change="filterTasks"
                                    style="width: 150px;"
                                >
                                    <el-option label="未开始" value="pending"></el-option>
                                    <el-option label="准备中" value="ready"></el-option>
                                    <el-option label="执行中" value="executing"></el-option>
                                    <el-option label="已暂停" value="paused"></el-option>
                                    <el-option label="已禁用" value="disabled"></el-option>
                                    <el-option label="已完成" value="completed"></el-option>
                                    <el-option label="已中止" value="aborted"></el-option>
                                </el-select>
                                
                                <el-select 
                                    v-model="taskFilter.robotId" 
                                    placeholder="选择执行机器人" 
                                    clearable
                                    @change="filterTasks"
                                    style="width: 150px;"
                                >
                                    <el-option 
                                        v-for="robot in robots" 
                                        :key="robot.id" 
                                        :label="robot.name" 
                                        :value="robot.id"
                                    ></el-option>
                                </el-select>
                                
                                <el-select 
                                    v-model="taskFilter.taskType" 
                                    placeholder="任务类型" 
                                    clearable
                                    @change="filterTasks"
                                    style="width: 130px;"
                                >
                                    <el-option label="定时任务" value="scheduled"></el-option>
                                    <el-option label="电量任务" value="battery"></el-option>
                                    <el-option label="闲时任务" value="idle"></el-option>
                                </el-select>
                                
                                <el-button @click="resetTaskFilter" type="default" style="margin-left: auto;">
                                    <i class="fas fa-undo" style="margin-right: 6px;"></i>重置筛选
                                </el-button>
                            </div>
                            
                            <!-- 任务列表 -->
                            <el-table :data="filteredTasks" style="width: 100%">
                                <el-table-column prop="id" label="任务ID" width="80"></el-table-column>
                                <el-table-column prop="name" label="任务名称" width="180"></el-table-column>
                                <el-table-column prop="templateName" label="模板名称" width="140"></el-table-column>
                                <el-table-column label="任务类型" width="100">
                                    <template #default="scope">
                                        <el-tag size="small" :type="scope.row.type === 'process' ? 'primary' : 'info'">
                                            {{ scope.row.type === 'process' ? '流程任务' : '简单任务' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="触发类型" width="100">
                                    <template #default="scope">
                                        <el-tag size="small" :type="getTriggerTypeTag(scope.row.triggerType)">
                                            {{ getTriggerTypeText(scope.row.triggerType) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="状态" width="120">
                                    <template #default="scope">
                                        <span :class="'status-tag status-' + scope.row.status">
                                            {{ getStatusText(scope.row.status) }}
                                        </span>
                                        <span v-if="scope.row.isRisk" class="status-tag status-risk" style="margin-left: 4px;">风险</span>
                                        <span v-else-if="scope.row.isHighRisk" class="status-tag status-high-risk" style="margin-left: 4px;">高风险</span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="robotName" label="执行机器人" width="120">
                                    <template #default="scope">
                                        <span v-if="scope.row.robotName">{{ scope.row.robotName }}</span>
                                        <span v-else style="color: #999;">未分配</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="优先级" width="80" align="center">
                                    <template #default="scope">
                                        <el-tag v-if="scope.row.priority === 1" type="danger" size="small">高</el-tag>
                                        <el-tag v-else-if="scope.row.priority === 2" type="warning" size="small">中</el-tag>
                                        <el-tag v-else type="info" size="small">低</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="组任务" width="80" align="center">
                                    <template #default="scope">
                                        <el-tag size="small" type="success" v-if="scope.row.isGroupTask">是</el-tag>
                                        <span v-else style="color: #999;">否</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="280" fixed="right">
                                    <template #default="scope">
                                        <el-button size="small" @click="viewTaskDetail(scope.row)">详情</el-button>
                                        <el-button 
                                            size="small" 
                                            type="primary" 
                                            @click="editTask(scope.row)"
                                            :disabled="!canEdit(scope.row)"
                                        >修改</el-button>
                                        <el-button 
                                            size="small" 
                                            type="danger" 
                                            @click="deleteTask(scope.row)"
                                            :disabled="!canDelete(scope.row)"
                                        >删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </div>
                </div>
                
                <!-- 3. 计划管理页面 - 修复拖拽排序版本 -->
                <div v-if="activeNav === 'scheduling'" class="task-scheduling-page">
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <i class="fas fa-list"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value">{{ tasks.length }}</div>
                                <div class="stat-label">总任务数</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value">{{ executingTasks.length }}</div>
                                <div class="stat-label">执行中</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value">{{ readyTasks.length }}</div>
                                <div class="stat-label">准备中</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">
                                <i class="fas fa-pause-circle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value">{{ pausedTasks.length }}</div>
                                <div class="stat-label">已暂停</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                所有任务
                                <el-tag v-if="schedulingFilter.robotId && schedulingFilter.readySortable" type="success" size="small" style="margin-left: 12px;">
                                    <i class="fas fa-check"></i> 准备中任务可拖拽排序
                                </el-tag>
                            </div>
                            <div>
                                <el-button type="text" @click="refreshTasks">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </el-button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <el-select 
                                    v-model="schedulingFilter.robotId" 
                                    placeholder="选择执行机器人" 
                                    clearable
                                    style="width: 180px;"
                                    @change="onRobotFilterChange"
                                >
                                    <el-option 
                                        v-for="robot in robots" 
                                        :key="robot.id" 
                                        :label="robot.name" 
                                        :value="robot.id"
                                    ></el-option>
                                </el-select>
                                
                                <el-select 
                                    v-model="schedulingFilter.status" 
                                    placeholder="任务状态" 
                                    clearable
                                    style="width: 150px;"
                                >
                                    <el-option label="未开始" value="pending"></el-option>
                                    <el-option label="准备中" value="ready"></el-option>
                                    <el-option label="执行中" value="executing"></el-option>
                                    <el-option label="已暂停" value="paused"></el-option>
                                </el-select>
                                
                                <el-switch
                                    v-if="schedulingFilter.robotId"
                                    v-model="schedulingFilter.readySortable"
                                    active-text="启用拖拽排序"
                                    style="margin-left: 12px;"
                                    @change="onSortableChange"
                                ></el-switch>
                                
                                <div style="margin-left: auto; color: #666; font-size: 13px;">
                                    <i class="fas fa-info-circle"></i> 
                                    选择机器人后：执行中 > 已暂停 > 准备中 > 未开始，同状态按优先级排序；准备中任务可拖拽调整顺序
                                </div>
                            </div>
                            
                            <el-table 
                        ref="schedulingTable"
                        :data="allTasksSorted" 
                        style="width: 100%"
                        :row-class-name="schedulingRowClassName"
                        row-key="id"
                        :key="tableKey"
                    >
                        <!-- 关键修复：拖拽控制列 - 只在启用拖拽且选择了机器人时显示 -->
                        <el-table-column 
                            width="80" 
                            align="center" 
                            v-if="schedulingFilter.robotId && schedulingFilter.readySortable"
                        >
                            <template #header>
                                <span>排序</span>
                            </template>
                            <template #default="scope">
                                <!-- 只有准备中任务显示拖拽手柄 -->
                                <div 
                                    v-if="scope.row.status === 'ready'" 
                                    class="drag-handle drag-enabled"
                                >
                                    <i class="fas fa-grip-vertical"></i>
                                    <span class="queue-position">{{ getReadyTaskVisualIndex(scope.row) + 1 }}</span>
                                </div>
                                <!-- 其他状态显示对应图标 -->
                                <div v-else style="color: #ccc;">
                                    <i v-if="scope.row.status === 'executing'" class="fas fa-play" style="color: #52c41a;"></i>
                                    <i v-else-if="scope.row.status === 'paused'" class="fas fa-pause" style="color: #faad14;"></i>
                                    <i v-else-if="scope.row.status === 'pending'" class="fas fa-clock" style="color: #999;"></i>
                                    <span v-else>-</span>
                                </div>
                            </template>
                        </el-table-column>
                                
                                <el-table-column prop="id" label="任务ID" width="80"></el-table-column>
                                <el-table-column prop="name" label="任务名称" width="180"></el-table-column>
                                <el-table-column prop="templateName" label="模板名称" width="140"></el-table-column>
                                <el-table-column label="状态" width="120">
                                    <template #default="scope">
                                        <span :class="'status-tag status-' + scope.row.status">
                                            {{ getStatusText(scope.row.status) }}
                                        </span>
                                        <div v-if="scope.row.isHighRisk" style="margin-top: 4px;">
                                            <span class="status-tag status-high-risk">高风险</span>
                                        </div>
                                        <div v-else-if="scope.row.isRisk" style="margin-top: 4px;">
                                            <span class="status-tag status-risk">风险</span>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="robotName" label="执行机器人" width="140">
                                    <template #default="scope">
                                        <div v-if="scope.row.robotName">
                                            {{ scope.row.robotName }}
                                            <div style="font-size: 12px; color: #999;">
                                                <span v-if="scope.row.robotStatus === 'online'" style="color: #52c41a;">
                                                    <i class="fas fa-circle" style="font-size: 8px;"></i> 在线
                                                </span>
                                                <span v-else-if="scope.row.robotStatus === 'offline'" style="color: #ff4d4f;">
                                                    <i class="fas fa-circle" style="font-size: 8px;"></i> 离线
                                                </span>
                                                <span v-else-if="scope.row.robotStatus === 'low_battery'" style="color: #fa8c16;">
                                                    <i class="fas fa-battery-quarter"></i> 电量低
                                                </span>
                                                <span v-else-if="scope.row.robotStatus === 'fault'" style="color: #ff4d4f;">
                                                    <i class="fas fa-exclamation"></i> 故障
                                                </span>
                                            </div>
                                        </div>
                                        <span v-else style="color: #999;">未分配</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="优先级" width="80" align="center">
                                    <template #default="scope">
                                        <el-tag v-if="scope.row.priority === 1" type="danger" size="small">高</el-tag>
                                        <el-tag v-else-if="scope.row.priority === 2" type="warning" size="small">中</el-tag>
                                        <el-tag v-else type="info" size="small">低</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="进度" width="180">
                                    <template #default="scope">
                                        <div class="step-progress">
                                            <div v-for="i in scope.row.totalSteps" :key="i" 
                                                 :class="['step-dot', 
                                                         i <= scope.row.completedSteps ? 'completed' : 
                                                         i === scope.row.completedSteps + 1 && scope.row.status === 'executing' ? 'executing' : '']">
                                            </div>
                                            <span style="margin-left: 8px; font-size: 12px;">
                                                {{ scope.row.completedSteps }}/{{ scope.row.totalSteps }}
                                            </span>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="updateTime" label="最后更新" width="150"></el-table-column>
                                <el-table-column label="操作" width="340" fixed="right">
                                    <template #default="scope">
                                        <el-button size="small" @click="viewTaskDetail(scope.row)">详情</el-button>
                                        
                                        <!-- 暂停/继续 -->
                                        <el-button 
                                            v-if="scope.row.status === 'executing' && !scope.row.isHighRisk"
                                            size="small" 
                                            type="warning" 
                                            @click="pauseTask(scope.row)"
                                        >暂停</el-button>
                                        <el-button 
                                            v-if="scope.row.status === 'paused'"
                                            size="small" 
                                            type="success" 
                                            @click="resumeTask(scope.row)"
                                            :disabled="!canResume(scope.row)"
                                        >继续</el-button>
                                        
                                        <!-- 启用/禁用 -->
                                        <el-button 
                                            v-if="scope.row.status !== 'disabled' && scope.row.status !== 'aborted'"
                                            size="small" 
                                            type="info" 
                                            @click="disableTask(scope.row)"
                                            :disabled="scope.row.status === 'executing' || scope.row.status === 'paused'"
                                        >禁用</el-button>
                                        <el-button 
                                            v-if="scope.row.status === 'disabled'"
                                            size="small" 
                                            type="primary" 
                                            @click="enableTask(scope.row)"
                                        >启用</el-button>
                                        
                                        <!-- 停止 -->
                                        <el-button 
                                            v-if="scope.row.status === 'executing' || scope.row.status === 'paused'"
                                            size="small" 
                                            type="danger" 
                                            @click="stopTask(scope.row)"
                                        >停止</el-button>
                                        
                                        <!-- 取消准备 -->
                                        <el-button 
                                            v-if="scope.row.status === 'ready'"
                                            size="small" 
                                            type="danger" 
                                            plain 
                                            @click="cancelTask(scope.row)"
                                        >
                                            <i class="fas fa-ban"></i> 取消
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </div>
                </div>
                
                <!-- 4. 异常处理页面 - 仅显示异常任务 -->
                <div v-if="activeNav === 'abnormal'" class="task-abnormal-page">
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-icon red">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" style="color: #ff4d4f;">{{ highRiskTasks.length }}</div>
                                <div class="stat-label">高风险任务（执行中）</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" style="color: #fa8c16;">{{ riskTasks.length }}</div>
                                <div class="stat-label">风险任务（未开始）</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value">{{ abnormalRobots.length }}</div>
                                <div class="stat-label">异常机器人</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value">{{ resolvedToday }}</div>
                                <div class="stat-label">今日已处理</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-exclamation-triangle" style="color: #ff4d4f; margin-right: 8px;"></i>
                                异常任务列表
                            </div>
                            <div>
                                <el-button type="primary" @click="refreshTasks">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </el-button>
                            </div>
                        </div>
                        <div class="card-body">
                            <el-alert
                                v-if="highRiskTasks.length > 0"
                                :title="`检测到 ${highRiskTasks.length} 个高风险任务（执行中），需要立即处理！`"
                                type="error"
                                :closable="false"
                                show-icon
                                class="abnormal-alert"
                            >
                                <template #default>
                                    <div>高风险任务表示正在执行中但机器人出现异常，必须先点击中止，然后选择重新分配或恢复。</div>
                                </template>
                            </el-alert>
                            
                            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                                <el-select 
                                    v-model="abnormalFilter.level" 
                                    placeholder="风险等级" 
                                    clearable
                                    style="width: 150px;"
                                >
                                    <el-option label="高风险（执行中）" value="high"></el-option>
                                    <el-option label="风险（未开始）" value="normal"></el-option>
                                </el-select>
                                
                                <el-select 
                                    v-model="abnormalFilter.robotId" 
                                    placeholder="异常机器人" 
                                    clearable
                                    style="width: 180px;"
                                >
                                    <el-option 
                                        v-for="robot in abnormalRobots" 
                                        :key="robot.id" 
                                        :label="robot.name" 
                                        :value="robot.id"
                                    ></el-option>
                                </el-select>
                                
                                <el-button @click="resetAbnormalFilter" style="margin-left: auto;">
                                    <i class="fas fa-undo" style="margin-right: 6px;"></i>重置筛选
                                </el-button>
                            </div>
                            
                            <el-table 
                                :data="filteredAbnormalTasks" 
                                style="width: 100%"
                                :row-class-name="tableRowClassName"
                                row-key="id"
                            >
                                <el-table-column prop="id" label="任务ID" width="80"></el-table-column>
                                <el-table-column prop="name" label="任务名称" width="180"></el-table-column>
                                <el-table-column label="风险等级" width="120" align="center">
                                    <template #default="scope">
                                        <el-tag 
                                            v-if="scope.row.isHighRisk" 
                                            type="danger" 
                                            effect="dark"
                                            style="font-size: 13px; padding: 4px 8px;"
                                        >
                                            <i class="fas fa-exclamation-triangle"></i> 高风险
                                        </el-tag>
                                        <el-tag 
                                            v-else-if="scope.row.isRisk" 
                                            type="warning" 
                                            effect="dark"
                                            style="font-size: 13px; padding: 4px 8px;"
                                        >
                                            <i class="fas fa-exclamation-circle"></i> 风险
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="任务状态" width="100">
                                    <template #default="scope">
                                        <span :class="'status-tag status-' + scope.row.status">
                                            {{ getStatusText(scope.row.status) }}
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="异常原因" width="150">
                                    <template #default="scope">
                                        <div v-if="scope.row.robotStatus === 'offline'">
                                            <i class="fas fa-wifi" style="color: #ff4d4f;"></i> 机器人离线
                                        </div>
                                        <div v-else-if="scope.row.robotStatus === 'fault'">
                                            <i class="fas fa-times-circle" style="color: #ff4d4f;"></i> 机器人故障
                                        </div>
                                        <div v-else-if="scope.row.robotStatus === 'low_battery'">
                                            <i class="fas fa-battery-quarter" style="color: #fa8c16;"></i> 电量不足
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="robotName" label="原执行机器人" width="120">
                                    <template #default="scope">
                                        <div>
                                            {{ scope.row.robotName }}
                                            <div style="font-size: 12px; color: #999;">
                                                {{ getRobotLocation(scope.row.robotId) }}
                                            </div>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="进度" width="120">
                                    <template #default="scope">
                                        <span>{{ scope.row.completedSteps }}/{{ scope.row.totalSteps }} 步骤</span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="updateTime" label="异常发生时间" width="150"></el-table-column>
                                <el-table-column label="操作" width="400" fixed="right">
                                    <template #default="scope">
                                        <el-button size="small" @click="viewTaskDetail(scope.row)">详情</el-button>
                                        
                                        <!-- 高风险任务：先中止 -->
                                        <template v-if="scope.row.isHighRisk">
                                            <el-button 
                                                v-if="scope.row.status !== 'paused'"
                                                size="small" 
                                                type="warning" 
                                                @click="abortHighRiskTask(scope.row)"
                                            >
                                                <i class="fas fa-stop"></i> 中止
                                            </el-button>
                                            <template v-if="scope.row.status === 'paused' && scope.row.wasHighRisk">
                                                <el-button 
                                                    size="small" 
                                                    type="primary" 
                                                    @click="showReassignDialog(scope.row)"
                                                >
                                                    <i class="fas fa-random"></i> 重新分配
                                                </el-button>
                                                <el-button 
                                                    size="small" 
                                                    type="success" 
                                                    @click="recoverTask(scope.row)"
                                                >
                                                    <i class="fas fa-check"></i> 恢复
                                                </el-button>
                                                <el-button 
                                                    size="small" 
                                                    type="danger" 
                                                    @click="terminateTask(scope.row)"
                                                >
                                                    <i class="fas fa-ban"></i> 终止
                                                </el-button>
                                            </template>
                                        </template>
                                        
                                        <!-- 风险任务：重新分配或恢复 -->
                                        <template v-if="scope.row.isRisk && !scope.row.isHighRisk">
                                            <el-button 
                                                size="small" 
                                                type="primary" 
                                                @click="showReassignDialog(scope.row)"
                                            >
                                                <i class="fas fa-random"></i> 重新分配
                                            </el-button>
                                            <el-button 
                                                size="small" 
                                                type="success" 
                                                @click="recoverTask(scope.row)"
                                            >
                                                <i class="fas fa-check"></i> 恢复
                                            </el-button>
                                        </template>
                                    </template>
                                </el-table-column>
                            </el-table>
                            
                            <div v-if="filteredAbnormalTasks.length === 0" style="text-align: center; padding: 60px 20px;">
                                <i class="fas fa-check-circle" style="font-size: 64px; color: #52c41a; margin-bottom: 16px;"></i>
                                <h3 style="color: #52c41a; margin-bottom: 8px;">暂无异常任务</h3>
                                <p style="color: #999;">所有任务运行正常，未发现风险或异常</p>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ==================== 对话框组件 ==================== -->
        
        <!-- 模板编辑对话框 -->
        <el-dialog 
            v-model="templateDialog.visible" 
            :title="templateDialog.mode === 'create' ? '新增模板' : '修改模板'" 
            width="80%"
            top="5vh"
        >
            <div style="height: 60vh; overflow-y: auto; padding-right: 10px;">
                <el-form :model="templateForm" label-width="100px">
                    <el-form-item label="模板名称" required>
                        <el-input v-model="templateForm.name" placeholder="请输入模板名称"></el-input>
                    </el-form-item>
                    
                    <el-form-item label="模板描述">
                        <el-input 
                            v-model="templateForm.description" 
                            type="textarea" 
                            placeholder="请输入模板描述"
                            :rows="3"
                        ></el-input>
                    </el-form-item>
                    
                    <el-form-item label="适用机器人组" required>
                        <el-select 
                            v-model="templateForm.robotGroupIds" 
                            multiple 
                            placeholder="请选择适用机器人组"
                            style="width: 100%;"
                        >
                            <el-option 
                                v-for="group in robotGroups" 
                                :key="group.id" 
                                :label="group.name" 
                                :value="group.id"
                            ></el-option>
                        </el-select>
                    </el-form-item>
                    
                    <el-form-item label="表单内容">
                        <div style="border: 1px solid #dcdfe6; border-radius: 4px; padding: 16px;">
                            <div style="margin-bottom: 16px; display: flex; justify-content: space-between;">
                                <span style="font-weight: bold;">表单字段定义</span>
                                <el-button size="small" type="primary" @click="addField">
                                    <i class="fas fa-plus"></i> 添加字段
                                </el-button>
                            </div>
                            
                            <div v-for="(field, index) in templateForm.fields" :key="index" 
                                 style="margin-bottom: 16px; padding: 12px; border: 1px dashed #dcdfe6; border-radius: 4px; background-color: #fafafa;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 500; color: #1890ff;">字段 {{ index + 1 }}</span>
                                    <el-button size="small" type="danger" plain @click="removeField(index)">删除</el-button>
                                </div>
                                
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="字段ID" label-width="80px" size="small">
                                            <el-input v-model="field.id" placeholder="如：start_location"></el-input>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="字段标签" label-width="80px" size="small">
                                            <el-input v-model="field.label" placeholder="如：起始位置"></el-input>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                                
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="字段类型" label-width="80px" size="small">
                                            <el-select v-model="field.type" placeholder="请选择字段类型" style="width: 100%;">
                                                <el-option label="文本" value="text"></el-option>
                                                <el-option label="数字" value="number"></el-option>
                                                <el-option label="日期" value="date"></el-option>
                                                <el-option label="时间" value="time"></el-option>
                                                <el-option label="下拉选择" value="select"></el-option>
                                                <el-option label="位置选择" value="location"></el-option>
                                            </el-select>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="是否必填" label-width="80px" size="small">
                                            <el-switch v-model="field.required"></el-switch>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </div>
                            
                            <div v-if="templateForm.fields.length === 0" style="text-align: center; color: #999; padding: 20px;">
                                <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 8px;"></i>
                                <div>暂无字段，请点击"添加字段"按钮添加</div>
                            </div>
                        </div>
                    </el-form-item>
                    
                    <el-form-item label="标准作业流程">
                        <div style="border: 1px solid #dcdfe6; border-radius: 4px; padding: 16px;">
                            <div style="margin-bottom: 16px; display: flex; justify-content: space-between;">
                                <span style="font-weight: bold;">流程步骤定义</span>
                                <el-button size="small" type="primary" @click="addStep">
                                    <i class="fas fa-plus"></i> 添加步骤
                                </el-button>
                            </div>
                            
                            <div v-for="(step, index) in templateForm.steps" :key="index" 
                                 style="margin-bottom: 16px; padding: 12px; border: 1px dashed #dcdfe6; border-radius: 4px; background-color: #fafafa;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 500; color: #52c41a;">步骤 {{ index + 1 }}</span>
                                    <el-button size="small" type="danger" plain @click="removeStep(index)">删除</el-button>
                                </div>
                                
                                <el-row :gutter="16">
                                    <el-col :span="12">
                                        <el-form-item label="步骤名称" label-width="80px" size="small">
                                            <el-input v-model="step.name" placeholder="如：前往药房"></el-input>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="12">
                                        <el-form-item label="预估时间(分)" label-width="100px" size="small">
                                            <el-input-number v-model="step.estimatedTime" :min="1" :max="120" style="width: 100%;"></el-input-number>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                                
                                <el-form-item label="步骤描述" label-width="80px" size="small">
                                    <el-input 
                                        v-model="step.description" 
                                        type="textarea" 
                                        placeholder="如：从起始位置导航到药房位置"
                                        :rows="2"
                                    ></el-input>
                                    <div class="field-hint">
                                        提示：使用<span v-pre>{{字段ID}}</span>引用字段值，如<span v-pre>{{start_location}}</span>
                                    </div>
                                </el-form-item>
                            </div>
                            
                            <div v-if="templateForm.steps.length === 0" style="text-align: center; color: #999; padding: 20px;">
                                <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 8px;"></i>
                                <div>暂无步骤，请点击"添加步骤"按钮添加</div>
                            </div>
                        </div>
                    </el-form-item>
                </el-form>
            </div>
            
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="templateDialog.visible = false">取消</el-button>
                    <el-button type="primary" @click="saveTemplate">保存</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- 任务创建/编辑对话框 -->
        <el-dialog 
            v-model="taskDialog.visible" 
            :title="taskDialog.title" 
            width="750px"
            top="5vh"
        >
            <div style="height: 60vh; overflow-y: auto; padding-right: 10px;">
                <el-form :model="taskForm" label-width="130px" :rules="taskRules" ref="taskFormRef">
                    <!-- 基本信息 -->
                    <el-form-item label="任务名称" prop="name" required>
                        <el-input v-model="taskForm.name" placeholder="请输入任务名称"></el-input>
                    </el-form-item>
                    
                    <!-- 完整流程任务 -->
                    <template v-if="taskForm.type === 'process'">
                        <el-form-item label="选择模板" prop="templateId" required>
                            <el-select 
                                v-model="taskForm.templateId" 
                                placeholder="请选择模板"
                                style="width: 100%;"
                                @change="onTemplateChange"
                                :disabled="taskDialog.mode === 'edit'"
                            >
                                <el-option 
                                    v-for="template in templates" 
                                    :key="template.id" 
                                    :label="template.name" 
                                    :value="template.id"
                                >
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>{{ template.name }}</span>
                                        <span style="color: #999; font-size: 12px;">
                                            {{ getRobotGroupNames(template.robotGroupIds) }}
                                        </span>
                                    </div>
                                </el-option>
                            </el-select>
                        </el-form-item>
                        
                        <!-- 模板表单字段 -->
                        <template v-if="taskForm.templateId && currentTemplate">
                            <el-form-item 
                                v-for="field in currentTemplate.fields" 
                                :key="field.id"
                                :label="field.label"
                                :required="field.required"
                            >
                                <el-input 
                                    v-if="field.type === 'text'"
                                    v-model="taskForm.formData[field.id]"
                                    :placeholder="'请输入' + field.label"
                                ></el-input>
                                
                                <el-input-number 
                                    v-else-if="field.type === 'number'"
                                    v-model="taskForm.formData[field.id]"
                                    style="width: 100%;"
                                    :placeholder="'请输入' + field.label"
                                ></el-input-number>
                                
                                <el-select 
                                    v-else-if="field.type === 'select'"
                                    v-model="taskForm.formData[field.id]"
                                    placeholder="请选择"
                                    style="width: 100%;"
                                >
                                    <el-option label="选项1" value="option1"></el-option>
                                    <el-option label="选项2" value="option2"></el-option>
                                    <el-option label="选项3" value="option3"></el-option>
                                </el-select>
                                
                                <el-date-picker
                                    v-else-if="field.type === 'date'"
                                    v-model="taskForm.formData[field.id]"
                                    type="date"
                                    placeholder="选择日期"
                                    style="width: 100%;"
                                ></el-date-picker>
                                
                                <el-time-picker
                                    v-else-if="field.type === 'time'"
                                    v-model="taskForm.formData[field.id]"
                                    placeholder="选择时间"
                                    style="width: 100%;"
                                ></el-time-picker>
                                
                                <el-input
                                    v-else-if="field.type === 'location'"
                                    v-model="taskForm.formData[field.id]"
                                    placeholder="请选择位置"
                                    style="width: 100%;"
                                >
                                    <template #append>
                                        <el-button @click="selectLocation(field.id)">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </el-button>
                                    </template>
                                </el-input>
                            </el-form-item>
                        </template>
                    </template>
                    
                    <!-- 简单动作任务 -->
                    <template v-if="taskForm.type === 'simple'">
                        <el-form-item label="选择简单作业" prop="simpleAction" required>
                            <el-select 
                                v-model="taskForm.simpleAction" 
                                placeholder="请选择简单作业"
                                style="width: 100%;"
                            >
                                <el-option 
                                    v-for="action in simpleActions" 
                                    :key="action.value" 
                                    :label="action.label" 
                                    :value="action.value"
                                ></el-option>
                            </el-select>
                        </el-form-item>
                    </template>
                    
                    <!-- 通用设置 -->
                    <el-divider content-position="left">任务设置</el-divider>
                    
                    <el-form-item label="任务优先级" prop="priority">
                        <el-radio-group v-model="taskForm.priority">
                            <el-radio :label="1">高</el-radio>
                            <el-radio :label="2">中</el-radio>
                            <el-radio :label="3">低</el-radio>
                        </el-radio-group>
                    </el-form-item>
                    
                    <el-form-item label="是否为组任务">
                        <el-switch v-model="taskForm.isGroupTask"></el-switch>
                        <span class="field-hint">组任务可由多个机器人协同完成</span>
                    </el-form-item>
                    
                    <el-form-item label="任务时长(分钟)" prop="duration">
                        <el-input-number v-model="taskForm.duration" :min="1" :max="480" style="width: 100%;"></el-input-number>
                    </el-form-item>
                    
                    <!-- 任务类型选择 -->
                    <el-form-item label="任务触发类型" prop="triggerType" required>
                        <el-radio-group v-model="taskForm.triggerType">
                            <el-radio label="scheduled">定时任务</el-radio>
                            <el-radio label="battery">电量任务</el-radio>
                            <el-radio label="idle">闲时任务</el-radio>
                        </el-radio-group>
                    </el-form-item>
                    
                    <!-- 定时任务设置 -->
                    <template v-if="taskForm.triggerType === 'scheduled'">
                        <el-form-item label="Cron表达式" prop="cronExpression">
                            <el-input 
                                v-model="taskForm.cronExpression" 
                                placeholder="如：0 0 9 * * ? 表示每天9点执行"
                            >
                                <template #append>
                                    <el-button @click="showCronHelp">帮助</el-button>
                                </template>
                            </el-input>
                            <div class="field-hint">格式：秒 分 时 日 月 周，留空表示立即执行</div>
                        </el-form-item>
                    </template>
                    
                    <!-- 电量任务设置 -->
                    <template v-if="taskForm.triggerType === 'battery'">
                        <el-form-item label="触发电量(%)" prop="triggerValue" required>
                            <el-slider v-model="taskForm.triggerValue" :max="100" show-input></el-slider>
                            <div class="field-hint">当机器人电量上升到该值时，任务进入准备队列</div>
                        </el-form-item>
                    </template>
                    
                    <!-- 闲时任务设置 -->
                    <template v-if="taskForm.triggerType === 'idle'">
                        <el-form-item label="待机时长(分钟)" prop="triggerValue" required>
                            <el-input-number v-model="taskForm.triggerValue" :min="1" :max="120" style="width: 100%;"></el-input-number>
                            <div class="field-hint">机器人进入待机界面多长时间后触发任务</div>
                        </el-form-item>
                    </template>
                    
                    <!-- 机器人选择 -->
                    <el-form-item :label="taskForm.isGroupTask ? '选择机器人组' : '选择机器人'" prop="robotId" required>
                        <template v-if="taskForm.isGroupTask">
                            <el-select v-model="taskForm.robotGroupId" placeholder="请选择机器人组" style="width: 100%;">
                                <el-option 
                                    v-for="group in robotGroups" 
                                    :key="group.id" 
                                    :label="group.name" 
                                    :value="group.id"
                                ></el-option>
                            </el-select>
                        </template>
                        <template v-else>
                            <el-select v-model="taskForm.robotId" placeholder="请选择机器人" style="width: 100%;">
                                <el-option 
                                    v-for="robot in availableRobots" 
                                    :key="robot.id" 
                                    :label="robot.name" 
                                    :value="robot.id"
                                >
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>{{ robot.name }}</span>
                                        <span style="color: #999; font-size: 12px;">
                                            电量{{ robot.battery }}% | {{ robot.status === 'online' ? '在线' : '离线' }}
                                        </span>
                                    </div>
                                </el-option>
                            </el-select>
                        </template>
                    </el-form-item>
                </el-form>
                
                <!-- 标准作业流程预览 -->
                <div v-if="taskForm.type === 'process' && currentTemplate" 
                     style="margin-top: 20px; border-top: 1px solid #e8e8e8; padding-top: 16px;">
                    <h4 style="margin-bottom: 12px; color: #1890ff;">
                        <i class="fas fa-clipboard-list"></i> 标准作业流程预览
                    </h4>
                    <div style="background: #f6ffed; border-radius: 4px; padding: 16px; border: 1px solid #b7eb8f;">
                        <div v-for="(step, index) in currentTemplate.steps" :key="index"
                             class="step-preview-item"
                             style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 4px; border-left: 3px solid #52c41a;">
                            <div style="display: flex; align-items: flex-start;">
                                <div style="width: 28px; height: 28px; background: #52c41a; color: white; 
                                            border-radius: 50%; text-align: center; line-height: 28px; 
                                            margin-right: 12px; font-weight: bold; flex-shrink: 0;">
                                    {{ index + 1 }}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; margin-bottom: 4px;">{{ step.name }}</div>
                                    <div style="color: #666; font-size: 13px; margin-bottom: 2px;">
                                        {{ renderStepDescription(step.description) }}
                                    </div>
                                    <div style="color: #999; font-size: 12px;">
                                        <i class="fas fa-clock"></i> 预估时间：{{ step.estimatedTime }}分钟
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="taskDialog.visible = false">取消</el-button>
                    <el-button type="primary" @click="saveTask" :loading="taskDialog.loading">
                        {{ taskDialog.mode === 'create' ? '创建任务' : '保存修改' }}
                    </el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- 任务详情对话框 -->
        <el-dialog 
            v-model="detailDialog.visible" 
            :title="'任务详情 - ' + (currentTask ? currentTask.name : '')" 
            width="800px"
            top="5vh"
        >
            <div v-if="currentTask" style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                <!-- 基本信息 -->
                <div class="task-detail-section">
                    <div class="task-detail-title">
                        <i class="fas fa-info-circle" style="color: #1890ff;"></i> 基本信息
                    </div>
                    <div class="task-detail-content">
                        <el-row :gutter="20">
                            <el-col :span="12">
                                <div class="detail-row">
                                    <div class="detail-label">任务名称：</div>
                                    <div class="detail-value">{{ currentTask.name }}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">模板名称：</div>
                                    <div class="detail-value">{{ currentTask.templateName || '-' }}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">任务类型：</div>
                                    <div class="detail-value">
                                        <el-tag size="small" :type="currentTask.type === 'process' ? 'primary' : 'info'">
                                            {{ currentTask.type === 'process' ? '完整流程任务' : '简单动作任务' }}
                                        </el-tag>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">触发类型：</div>
                                    <div class="detail-value">
                                        <el-tag size="small" :type="getTriggerTypeTag(currentTask.triggerType)">
                                            {{ getTriggerTypeText(currentTask.triggerType) }}
                                        </el-tag>
                                        <span v-if="currentTask.triggerType === 'battery'" style="margin-left: 8px; color: #666;">
                                            (电量 ≥ {{ currentTask.triggerValue }}%)
                                        </span>
                                        <span v-if="currentTask.triggerType === 'idle'" style="margin-left: 8px; color: #666;">
                                            (待机 ≥ {{ currentTask.triggerValue }}分钟)
                                        </span>
                                    </div>
                                </div>
                            </el-col>
                            <el-col :span="12">
                                <div class="detail-row">
                                    <div class="detail-label">任务状态：</div>
                                    <div class="detail-value">
                                        <span :class="'status-tag status-' + currentTask.status">
                                            {{ getStatusText(currentTask.status) }}
                                        </span>
                                        <span v-if="currentTask.isHighRisk" class="status-tag status-high-risk" style="margin-left: 4px;">高风险</span>
                                        <span v-else-if="currentTask.isRisk" class="status-tag status-risk" style="margin-left: 4px;">风险</span>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">是否组任务：</div>
                                    <div class="detail-value">
                                        <el-tag size="small" type="success" v-if="currentTask.isGroupTask">是</el-tag>
                                        <span v-else>否</span>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">执行机器人组：</div>
                                    <div class="detail-value">
                                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                            <el-tag 
                                                v-for="groupId in currentTask.robotGroupIds" 
                                                :key="groupId" 
                                                size="small"
                                                type="info"
                                            >
                                                {{ getRobotGroupName(groupId) }}
                                            </el-tag>
                                        </div>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">执行机器人：</div>
                                    <div class="detail-value">
                                        <span v-if="currentTask.robotName">{{ currentTask.robotName }}</span>
                                        <span v-else style="color: #999;">未分配</span>
                                    </div>
                                </div>
                            </el-col>
                        </el-row>
                        
                        <el-divider style="margin: 16px 0;"></el-divider>
                        
                        <el-row :gutter="20">
                            <el-col :span="12">
                                <div class="detail-row">
                                    <div class="detail-label">任务优先级：</div>
                                    <div class="detail-value">
                                        <el-tag v-if="currentTask.priority === 1" type="danger" size="small">高</el-tag>
                                        <el-tag v-else-if="currentTask.priority === 2" type="warning" size="small">中</el-tag>
                                        <el-tag v-else type="info" size="small">低</el-tag>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">任务时长：</div>
                                    <div class="detail-value">{{ currentTask.duration }} 分钟</div>
                                </div>
                            </el-col>
                            <el-col :span="12">
                                <div class="detail-row">
                                    <div class="detail-label">创建时间：</div>
                                    <div class="detail-value">{{ currentTask.createdTime }}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">最后修改：</div>
                                    <div class="detail-value">{{ currentTask.updateTime }}</div>
                                </div>
                            </el-col>
                        </el-row>
                    </div>
                </div>
                
                <!-- 表单内容 -->
                <div v-if="currentTask.formData && Object.keys(currentTask.formData).length > 0" class="task-detail-section">
                    <div class="task-detail-title">
                        <i class="fas fa-edit" style="color: #52c41a;"></i> 表单内容
                    </div>
                    <div class="task-detail-content">
                        <el-descriptions :column="2" border>
                            <el-descriptions-item 
                                v-for="(value, key) in currentTask.formData" 
                                :key="key" 
                                :label="getFieldLabel(key)"
                            >
                                {{ value }}
                            </el-descriptions-item>
                        </el-descriptions>
                    </div>
                </div>
                
                <!-- 作业步骤实时状态 -->
                <div v-if="currentTask.steps && currentTask.steps.length > 0" class="task-detail-section">
                    <div class="task-detail-title">
                        <i class="fas fa-list-ol" style="color: #faad14;"></i> 作业步骤实时状态
                    </div>
                    <div class="step-list">
                        <div v-for="(step, index) in currentTask.steps" :key="index" class="step-item">
                            <div class="step-info">
                                <div class="step-index" :style="{ 
                                    backgroundColor: step.status === 'completed' ? '#52c41a' : 
                                                    step.status === 'executing' ? '#1890ff' : '#f0f0f0',
                                    color: step.status === 'pending' ? '#666' : 'white'
                                }">
                                    <i v-if="step.status === 'completed'" class="fas fa-check"></i>
                                    <i v-else-if="step.status === 'executing'" class="fas fa-spinner fa-spin"></i>
                                    <span v-else>{{ index + 1 }}</span>
                                </div>
                                <div class="step-content">
                                    <div class="step-title">{{ step.name }}</div>
                                    <div class="step-desc">{{ step.description }}</div>
                                    <div v-if="step.startTime" style="font-size: 12px; color: #999; margin-top: 4px;">
                                        开始时间：{{ step.startTime }}
                                    </div>
                                    <div v-if="step.endTime" style="font-size: 12px; color: #999;">
                                        完成时间：{{ step.endTime }}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <span :class="'status-tag status-' + step.status">
                                    {{ getStepStatusText(step.status) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 任务日志 -->
                <div class="task-detail-section">
                    <div class="task-detail-title">
                        <i class="fas fa-history" style="color: #722ed1;"></i> 任务日志
                    </div>
                    <div class="task-detail-content" style="max-height: 300px; overflow-y: auto;">
                        <el-timeline>
                            <el-timeline-item 
                                v-for="(log, index) in currentTask.logs" 
                                :key="index"
                                :type="log.type || 'info'"
                                :timestamp="log.time"
                            >
                                <div style="font-weight: 500;">{{ log.action }}</div>
                                <div style="color: #666; font-size: 13px; margin-top: 4px;">{{ log.details }}</div>
                            </el-timeline-item>
                        </el-timeline>
                        
                        <div v-if="currentTask.logs.length === 0" style="text-align: center; color: #999; padding: 20px;">
                            暂无日志记录
                        </div>
                    </div>
                </div>
            </div>
            
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="detailDialog.visible = false">关闭</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- 重新分配对话框 -->
        <el-dialog 
            v-model="reassignDialog.visible" 
            title="重新分配任务" 
            width="600px"
        >
            <div v-if="reassignDialog.task">
                <el-alert
                    v-if="reassignDialog.task.isHighRisk"
                    title="高风险任务"
                    type="error"
                    description="此任务正在执行中但机器人出现异常，需要立即重新分配"
                    show-icon
                    style="margin-bottom: 16px;"
                ></el-alert>
                
                <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 4px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">任务信息</div>
                    <div>任务名称：{{ reassignDialog.task.name }}</div>
                    <div>原执行机器人：{{ reassignDialog.task.robotName }}</div>
                    <div>适用机器人组：{{ getRobotGroupNames(reassignDialog.task.robotGroupIds) }}</div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">可用机器人</div>
                    <div v-if="availableRobotsForReassign.length === 0" style="color: #999; text-align: center; padding: 20px; background: #f5f5f5; border-radius: 4px;">
                        <i class="fas fa-robot" style="font-size: 24px; margin-bottom: 8px;"></i>
                        <div>当前没有可用的机器人</div>
                    </div>
                    <div v-else>
                        <el-radio-group v-model="reassignDialog.selectedRobotId">
                            <div v-for="robot in availableRobotsForReassign" :key="robot.id" 
                                 style="margin-bottom: 12px; padding: 12px; border: 1px solid #dcdfe6; border-radius: 4px; width: 100%;">
                                <el-radio :label="robot.id" style="width: 100%;">
                                    <div style="display: flex; align-items: center; width: 100%;">
                                        <div style="margin-right: 12px;">
                                            <i class="fas fa-robot" style="font-size: 24px; color: #1890ff;"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold;">{{ robot.name }}</div>
                                            <div style="font-size: 12px; color: #666;">
                                                <span style="color: #52c41a;">
                                                    <i class="fas fa-battery-full"></i> {{ robot.battery }}%
                                                </span>
                                                <span style="margin-left: 12px;">
                                                    <i class="fas fa-map-marker-alt"></i> {{ robot.location }}
                                                </span>
                                                <span style="margin-left: 12px; color: #52c41a;">
                                                    <i class="fas fa-circle" style="font-size: 8px;"></i> 在线
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </el-radio>
                            </div>
                        </el-radio-group>
                    </div>
                </div>
            </div>
            
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="reassignDialog.visible = false">取消</el-button>
                    <el-button 
                        type="primary" 
                        @click="confirmReassign"
                        :disabled="!reassignDialog.selectedRobotId"
                    >确认分配</el-button>
                </span>
            </template>
        </el-dialog>
        
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.2/echarts.min.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        const app = createApp({
            setup() {
                // ==================== 基础状态 ====================
                const activeNav = ref('tasks');
                const expandedMenu = ref('taskManagement');
                const queuePositionKey = ref(0);
                const tableKey = ref(0); // 关键：用于强制重新渲染表格
                
                const pageTitles = {
                    'templates': '模板管理',
                    'tasks': '任务管理',
                    'scheduling': '计划管理',
                    'abnormal': '异常处理'
                };
                
                const getPageTitle = () => pageTitles[activeNav.value] || '任务管理';
                
                // ==================== 导航控制 ====================
                const toggleMenu = (menuName) => {
                    expandedMenu.value = expandedMenu.value === menuName ? '' : menuName;
                };
                
                const switchNav = (navName) => {
                    activeNav.value = navName;
                    history.pushState(null, null, '#' + navName);
                };
                
                onMounted(() => {
                    const hash = window.location.hash.replace('#', '');
                    const validPages = ['templates', 'tasks', 'scheduling', 'abnormal'];
                    if (validPages.includes(hash)) {
                        activeNav.value = hash;
                    }
                    window.addEventListener('hashchange', () => {
                        const newHash = window.location.hash.replace('#', '');
                        if (validPages.includes(newHash)) {
                            activeNav.value = newHash;
                        }
                    });
                });
                
                // ==================== 数据定义 ====================
                const robotGroups = ref([
                    { id: 1, name: '配送机器人组' },
                    { id: 2, name: '巡检机器人组' },
                    { id: 3, name: '清洁机器人组' },
                    { id: 4, name: '安防机器人组' }
                ]);
                
                const robots = ref([
                    { id: 1, name: '机器人A', groupId: 1, battery: 85, status: 'online', location: '药房' },
                    { id: 2, name: '机器人B', groupId: 1, battery: 42, status: 'low_battery', location: '病房区' },
                    { id: 3, name: '机器人C', groupId: 2, battery: 92, status: 'online', location: '门诊大厅' },
                    { id: 4, name: '机器人D', groupId: 3, battery: 78, status: 'online', location: '走廊' },
                    { id: 5, name: '机器人E', groupId: 4, battery: 65, status: 'offline', location: '监控室' },
                    { id: 6, name: '机器人F', groupId: 2, battery: 95, status: 'online', location: '大厅' },
                    { id: 7, name: '机器人G', groupId: 1, battery: 88, status: 'online', location: '急诊室' },
                    { id: 8, name: '机器人H', groupId: 3, battery: 35, status: 'low_battery', location: '手术室' },
                    { id: 9, name: '机器人I', groupId: 2, battery: 76, status: 'online', location: 'ICU' },
                    { id: 10, name: '机器人J', groupId: 4, battery: 82, status: 'online', location: '停车场' },
                    { id: 11, name: '机器人K', groupId: 1, battery: 91, status: 'online', location: '药房2' },
                    { id: 12, name: '机器人L', groupId: 3, battery: 45, status: 'fault', location: '大厅B' }
                ]);

                
                const templates = ref([
                    {
                        id: 1,
                        name: '药品配送模板',
                        description: '院内药品配送标准流程，支持多科室配送',
                        robotGroupIds: [1],
                        fields: [
                            { id: 'start_location', label: '起始位置', type: 'location', required: true },
                            { id: 'pharmacy_location', label: '药房位置', type: 'location', required: true },
                            { id: 'drug_name', label: '药品名称', type: 'text', required: true },
                            { id: 'receiver_dept', label: '接收科室', type: 'select', required: true },
                            { id: 'delivery_date', label: '配送日期', type: 'date', required: false }
                        ],
                        steps: [
                            { name: '任务接收', description: '接收配送任务指令', estimatedTime: 2 },
                            { name: '前往药房', description: '从起始位置导航到药房位置', estimatedTime: 10 },
                            { name: '药品领取', description: '取走药品，核对药品信息', estimatedTime: 5 },
                            { name: '药品配送', description: '将药品送至接收科室', estimatedTime: 15 },
                            { name: '交接确认', description: '与接收人员交接药品并确认', estimatedTime: 3 }
                        ]
                    },
                    {
                        id: 2,
                        name: '银行巡检模板',
                        description: '银行网点安全巡检流程，包含门禁、监控等检查',
                        robotGroupIds: [2, 4],
                        fields: [
                            { id: 'bank_branch', label: '支行名称', type: 'text', required: true },
                            { id: 'inspection_items', label: '巡检项目', type: 'select', required: true },
                            { id: 'inspection_time', label: '巡检时间', type: 'time', required: true }
                        ],
                        steps: [
                            { name: '任务启动', description: '启动巡检任务，检查设备状态', estimatedTime: 2 },
                            { name: '网点到达', description: '导航至目标支行', estimatedTime: 20 },
                            { name: '安全巡检', description: '执行巡检项目检查', estimatedTime: 30 },
                            { name: '异常上报', description: '上报巡检发现的问题', estimatedTime: 5 },
                            { name: '任务完成', description: '返回基地并生成报告', estimatedTime: 15 }
                        ]
                    },
                    {
                        id: 3,
                        name: '设备维护模板',
                        description: '医疗设备定期维护流程',
                        robotGroupIds: [2],
                        fields: [
                            { id: 'device_name', label: '设备名称', type: 'text', required: true },
                            { id: 'device_location', label: '设备位置', type: 'location', required: true },
                            { id: 'maintenance_type', label: '维护类型', type: 'select', required: true }
                        ],
                        steps: [
                            { name: '准备工作', description: '准备维护工具和设备', estimatedTime: 5 },
                            { name: '前往设备位置', description: '导航至设备位置', estimatedTime: 10 },
                            { name: '设备检查', description: '对设备进行维护类型检查', estimatedTime: 25 },
                            { name: '维护记录', description: '记录维护结果和问题', estimatedTime: 5 }
                        ]
                    }
                ]);
                
                // ==================== 任务数据（已添加机器人A的多个准备中任务） ====================
                const tasks = ref([
                    // 机器人A的执行中任务
                    {
                        id: 1000,
                        name: '配送任务-药品A-执行中',
                        templateName: '药品配送模板',
                        type: 'process',
                        status: 'executing',
                        isRisk: false,
                        isHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 1,
                        robotName: '机器人A',
                        robotStatus: 'online',
                        robotGroupIds: [1],
                        priority: 1,
                        duration: 35,
                        createdTime: '2023-10-20 07:00:00',
                        updateTime: '2023-10-20 10:00:00',
                        completedSteps: 3,
                        totalSteps: 5,
                        logs: [{ action: '任务执行中', time: '2023-10-20 10:00:00', details: '正在执行第3步', type: 'success' }]
                    },
                    // 机器人A的准备中任务（4个，用于测试拖拽排序）
                    {
                        id: 2001,
                        name: '配送任务-药品B-准备中',
                        templateName: '药品配送模板',
                        type: 'process',
                        status: 'ready',
                        isRisk: false,
                        isHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 1,
                        robotName: '机器人A',
                        robotStatus: 'online',
                        robotGroupIds: [1],
                        priority: 1,
                        duration: 35,
                        createdTime: '2023-10-20 08:00:00',
                        updateTime: '2023-10-20 08:00:00',
                        completedSteps: 0,
                        totalSteps: 5,
                        logs: [{ action: '任务创建', time: '2023-10-20 08:00:00', details: '进入准备队列', type: 'info' }]
                    },
                    {
                        id: 2002,
                        name: '配送任务-药品C-准备中',
                        templateName: '药品配送模板',
                        type: 'process',
                        status: 'ready',
                        isRisk: false,
                        isHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 1,
                        robotName: '机器人A',
                        robotStatus: 'online',
                        robotGroupIds: [1],
                        priority: 2,
                        duration: 35,
                        createdTime: '2023-10-20 08:30:00',
                        updateTime: '2023-10-20 08:30:00',
                        completedSteps: 0,
                        totalSteps: 5,
                        logs: [{ action: '任务创建', time: '2023-10-20 08:30:00', details: '进入准备队列', type: 'info' }]
                    },
                    {
                        id: 2003,
                        name: '配送任务-药品D-准备中',
                        templateName: '药品配送模板',
                        type: 'process',
                        status: 'ready',
                        isRisk: false,
                        isHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 1,
                        robotName: '机器人A',
                        robotStatus: 'online',
                        robotGroupIds: [1],
                        priority: 2,
                        duration: 35,
                        createdTime: '2023-10-20 09:00:00',
                        updateTime: '2023-10-20 09:00:00',
                        completedSteps: 0,
                        totalSteps: 5,
                        logs: [{ action: '任务创建', time: '2023-10-20 09:00:00', details: '进入准备队列', type: 'info' }]
                    },
                    {
                        id: 2004,
                        name: '配送任务-急救药品-准备中',
                        templateName: '药品配送模板',
                        type: 'process',
                        status: 'ready',
                        isRisk: false,
                        isHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 1,
                        robotName: '机器人A',
                        robotStatus: 'online',
                        robotGroupIds: [1],
                        priority: 1,
                        duration: 20,
                        createdTime: '2023-10-20 09:30:00',
                        updateTime: '2023-10-20 09:30:00',
                        completedSteps: 0,
                        totalSteps: 3,
                        logs: [{ action: '紧急任务创建', time: '2023-10-20 09:30:00', details: '急救药品，优先处理', type: 'warning' }]
                    },
                    // 其他机器人的任务
                    {
                        id: 3001,
                        name: '巡检任务-门诊大厅',
                        templateName: '巡检任务',
                        type: 'simple',
                        status: 'ready',
                        isRisk: false,
                        isHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 3,
                        robotName: '机器人C',
                        robotStatus: 'online',
                        robotGroupIds: [2],
                        priority: 2,
                        duration: 60,
                        createdTime: '2023-10-20 08:15:00',
                        updateTime: '2023-10-20 08:15:00',
                        completedSteps: 0,
                        totalSteps: 4,
                        logs: [{ action: '任务创建', time: '2023-10-20 08:15:00', details: '进入准备队列', type: 'info' }]
                    },
                    // 高风险任务
                    {
                        id: 4001,
                        name: '高风险-夜间巡逻',
                        templateName: '安防巡逻',
                        type: 'simple',
                        status: 'executing',
                        isRisk: false,
                        isHighRisk: true,
                        wasHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 5,
                        robotName: '机器人E',
                        robotStatus: 'offline',
                        robotGroupIds: [4],
                        priority: 2,
                        duration: 240,
                        createdTime: '2023-10-19 18:30:00',
                        updateTime: '2023-10-20 10:00:00',
                        completedSteps: 3,
                        totalSteps: 5,
                        logs: [{ action: '异常检测', time: '2023-10-20 10:00:00', details: '检测到机器人E离线', type: 'danger' }]
                    },
                    // 风险任务
                    {
                        id: 5001,
                        name: '风险任务-巡检',
                        templateName: '巡检任务',
                        type: 'simple',
                        status: 'pending',
                        isRisk: true,
                        isHighRisk: false,
                        wasHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 2,
                        robotName: '机器人B',
                        robotStatus: 'low_battery',
                        robotGroupIds: [2],
                        priority: 2,
                        duration: 60,
                        createdTime: '2023-10-20 08:00:00',
                        updateTime: '2023-10-20 09:30:00',
                        completedSteps: 0,
                        totalSteps: 4,
                        logs: [{ action: '电量警告', time: '2023-10-20 09:30:00', details: '电量低于50%', type: 'warning' }]
                    },
                    // 已暂停任务
                    {
                        id: 6001,
                        name: '已暂停-设备维护',
                        templateName: '设备维护模板',
                        type: 'process',
                        status: 'paused',
                        isRisk: false,
                        isHighRisk: false,
                        wasHighRisk: false,
                        triggerType: 'scheduled',
                        robotId: 1,
                        robotName: '机器人A',
                        robotStatus: 'online',
                        robotGroupIds: [2],
                        priority: 2,
                        duration: 45,
                        createdTime: '2023-10-20 07:30:00',
                        updateTime: '2023-10-20 09:45:00',
                        completedSteps: 2,
                        totalSteps: 4,
                        logs: [
                            { action: '任务创建', time: '2023-10-20 07:30:00', details: '进入准备队列', type: 'info' },
                            { action: '任务开始', time: '2023-10-20 08:00:00', details: '机器人A开始执行', type: 'success' },
                            { action: '任务暂停', time: '2023-10-20 09:45:00', details: '管理员暂停任务', type: 'warning' }
                        ]
                    }
                ]);
                
                // ==================== 辅助函数 ====================
                const getRobotGroupName = (groupId) => {
                    const group = robotGroups.value.find(g => g.id == groupId);
                    return group ? group.name : groupId;
                };
                
                const getRobotGroupNames = (groupIds) => {
                    return groupIds.map(id => getRobotGroupName(id)).join(', ');
                };
                
                const getRobotLocation = (robotId) => {
                    const robot = robots.value.find(r => r.id === robotId);
                    return robot ? robot.location : '未知位置';
                };
                
                const statusTextMap = {
                    'pending': '未开始',
                    'ready': '准备中',
                    'executing': '执行中',
                    'paused': '已暂停',
                    'completed': '已完成',
                    'disabled': '已禁用',
                    'aborted': '已中止'
                };
                
                const getStatusText = (status) => statusTextMap[status] || status;
                
                const triggerTypeMap = {
                    'scheduled': '定时任务',
                    'battery': '电量任务',
                    'idle': '闲时任务'
                };
                
                const getTriggerTypeText = (type) => triggerTypeMap[type] || type;
                
                const getTriggerTypeTag = (type) => {
                    const map = { 'scheduled': 'primary', 'battery': 'success', 'idle': 'warning' };
                    return map[type] || 'info';
                };
                
                const getStepStatusText = (status) => {
                    const map = { 'pending': '未开始', 'executing': '执行中', 'completed': '已完成', 'error': '异常' };
                    return map[status] || status;
                };
                
                // ==================== 模板管理 ====================
                const templateFilter = reactive({ keyword: '', robotGroup: '' });
                
                const filteredTemplates = computed(() => {
                    let result = templates.value;
                    if (templateFilter.keyword) {
                        const keyword = templateFilter.keyword.toLowerCase();
                        result = result.filter(t => 
                            t.name.toLowerCase().includes(keyword) || 
                            (t.description && t.description.toLowerCase().includes(keyword))
                        );
                    }
                    if (templateFilter.robotGroup) {
                        result = result.filter(t => t.robotGroupIds.includes(parseInt(templateFilter.robotGroup)));
                    }
                    return result;
                });
                
                const filterTemplates = () => {};
                const resetTemplateFilter = () => {
                    templateFilter.keyword = '';
                    templateFilter.robotGroup = '';
                };
                
                const templateDialog = reactive({ visible: false, mode: 'create' });
                const templateForm = reactive({
                    id: null,
                    name: '',
                    description: '',
                    robotGroupIds: [],
                    fields: [],
                    steps: []
                });
                
                const showTemplateDialog = (mode, template = null) => {
                    templateDialog.mode = mode;
                    if (mode === 'create') {
                        Object.assign(templateForm, {
                            id: null,
                            name: '',
                            description: '',
                            robotGroupIds: [],
                            fields: [],
                            steps: []
                        });
                    } else if (template) {
                        Object.assign(templateForm, {
                            id: template.id,
                            name: template.name,
                            description: template.description,
                            robotGroupIds: [...template.robotGroupIds],
                            fields: JSON.parse(JSON.stringify(template.fields)),
                            steps: JSON.parse(JSON.stringify(template.steps))
                        });
                    }
                    templateDialog.visible = true;
                };
                
                const addField = () => {
                    templateForm.fields.push({ id: '', label: '', type: 'text', required: false });
                };
                
                const removeField = (index) => {
                    templateForm.fields.splice(index, 1);
                };
                
                const addStep = () => {
                    templateForm.steps.push({ name: '', description: '', estimatedTime: 5 });
                };
                
                const removeStep = (index) => {
                    templateForm.steps.splice(index, 1);
                };
                
                const saveTemplate = () => {
                    if (!templateForm.name.trim()) {
                        ElMessage.error('请输入模板名称');
                        return;
                    }
                    if (templateForm.robotGroupIds.length === 0) {
                        ElMessage.error('请选择至少一个适用机器人组');
                        return;
                    }
                    
                    if (templateDialog.mode === 'create') {
                        const newId = Math.max(...templates.value.map(t => t.id), 0) + 1;
                        templates.value.push({
                            ...JSON.parse(JSON.stringify(templateForm)),
                            id: newId
                        });
                        ElMessage.success('模板创建成功');
                    } else {
                        const index = templates.value.findIndex(t => t.id === templateForm.id);
                        if (index !== -1) {
                            templates.value[index] = JSON.parse(JSON.stringify(templateForm));
                        }
                        ElMessage.success('模板修改成功');
                    }
                    templateDialog.visible = false;
                };
                
                const viewTemplate = (template) => {
                    const fieldsHtml = template.fields.map(f => 
                        `<div style="margin-bottom: 8px;"><strong>${f.label}</strong> (${f.id}) - ${f.type}${f.required ? ' <span style="color: red;">*</span>' : ''}</div>`
                    ).join('');
                    
                    const stepsHtml = template.steps.map((s, i) => 
                        `<div style="margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                            <div><strong>步骤 ${i+1}:</strong> ${s.name}</div>
                            <div style="color: #666; font-size: 13px; margin-top: 4px;">${s.description}</div>
                            <div style="color: #999; font-size: 12px; margin-top: 4px;">预估时间: ${s.estimatedTime}分钟</div>
                        </div>`
                    ).join('');
                    
                    ElMessageBox.alert(`
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <h3 style="margin-bottom: 16px; color: #1890ff;">${template.name}</h3>
                            <p style="margin-bottom: 16px; color: #666;">${template.description}</p>
                            
                            <div style="margin-bottom: 16px;">
                                <strong>适用机器人组：</strong>
                                <div style="margin-top: 8px;">${getRobotGroupNames(template.robotGroupIds)}</div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <strong>表单字段 (${template.fields.length}个)：</strong>
                                <div style="margin-top: 8px; padding: 12px; background: #fafafa; border-radius: 4px;">
                                    ${fieldsHtml || '<div style="color: #999;">无字段定义</div>'}
                                </div>
                            </div>
                            
                            <div>
                                <strong>标准作业流程 (${template.steps.length}个步骤)：</strong>
                                <div style="margin-top: 8px;">
                                    ${stepsHtml || '<div style="color: #999;">无步骤定义</div>'}
                                </div>
                            </div>
                        </div>
                    `, '模板详情', {
                        dangerouslyUseHTMLString: true,
                        width: '600px'
                    });
                };
                
                const deleteTemplate = (id) => {
                    ElMessageBox.confirm('确定要删除这个模板吗？删除后基于该模板的任务将无法正常使用。', '确认删除', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        const index = templates.value.findIndex(t => t.id === id);
                        if (index !== -1) {
                            templates.value.splice(index, 1);
                            ElMessage.success('模板删除成功');
                        }
                    }).catch(() => {});
                };
                
                // ==================== 任务管理 ====================
                const taskFilter = reactive({ keyword: '', status: '', robotId: '', taskType: '' });
                
                const filteredTasks = computed(() => {
                    let result = tasks.value;
                    if (taskFilter.keyword) {
                        const keyword = taskFilter.keyword.toLowerCase();
                        result = result.filter(t => 
                            t.name.toLowerCase().includes(keyword) || 
                            (t.templateName && t.templateName.toLowerCase().includes(keyword))
                        );
                    }
                    if (taskFilter.status) result = result.filter(t => t.status === taskFilter.status);
                    if (taskFilter.robotId) result = result.filter(t => t.robotId == taskFilter.robotId);
                    if (taskFilter.taskType) result = result.filter(t => t.triggerType === taskFilter.taskType);
                    return result;
                });
                
                const filterTasks = () => {};
                const resetTaskFilter = () => {
                    Object.keys(taskFilter).forEach(key => taskFilter[key] = '');
                };
                
                const canEdit = (task) => ['pending', 'ready', 'disabled'].includes(task.status);
                const canDelete = (task) => ['pending', 'ready', 'disabled', 'completed', 'aborted'].includes(task.status);
                
                // ==================== 任务创建/编辑对话框 ====================
                const taskDialog = reactive({ 
                    visible: false, 
                    mode: 'create', 
                    title: '',
                    loading: false
                });
                
                const taskFormRef = ref(null);
                const taskForm = reactive({
                    id: null,
                    name: '',
                    type: 'process',
                    templateId: null,
                    simpleAction: '',
                    formData: {},
                    priority: 2,
                    isGroupTask: false,
                    duration: 30,
                    triggerType: 'scheduled',
                    triggerValue: null,
                    cronExpression: '',
                    robotId: null,
                    robotGroupId: null
                });
                
                const currentTemplate = computed(() => {
                    return templates.value.find(t => t.id === taskForm.templateId);
                });
                
                const simpleActions = ref([
                    { value: '清洁', label: '清洁任务' },
                    { value: '巡检', label: '巡检任务' },
                    { value: '配送', label: '配送任务' },
                    { value: '安防', label: '安防巡逻' },
                    { value: '送餐', label: '送餐服务' }
                ]);
                
                const availableRobots = computed(() => {
                    let available = robots.value.filter(r => r.status === 'online' && r.battery > 20);
                    
                    if (taskForm.type === 'process' && taskForm.templateId) {
                        const template = templates.value.find(t => t.id === taskForm.templateId);
                        if (template) {
                            available = available.filter(r => template.robotGroupIds.includes(r.groupId));
                        }
                    } else if (taskForm.type === 'simple') {
                        available = available.filter(r => r.groupId === 3 || r.groupId === 1);
                    }
                    
                    return available;
                });
                
                const taskRules = {
                    name: [{ required: true, message: '请输入任务名称', trigger: 'blur' }],
                    templateId: [{ required: true, message: '请选择模板', trigger: 'change' }],
                    simpleAction: [{ required: true, message: '请选择简单作业', trigger: 'change' }],
                    robotId: [{ required: true, message: '请选择机器人', trigger: 'change' }]
                };
                
                const showTaskDialog = (type, task = null) => {
                    taskDialog.mode = task ? 'edit' : 'create';
                    taskDialog.title = task ? '修改任务' : (type === 'process' ? '创建完整流程任务' : '创建简单动作任务');
                    
                    if (task) {
                        Object.assign(taskForm, {
                            id: task.id,
                            name: task.name,
                            type: task.type,
                            templateId: task.templateId,
                            simpleAction: task.simpleAction || '',
                            formData: { ...(task.formData || {}) },
                            priority: task.priority,
                            isGroupTask: task.isGroupTask,
                            duration: task.duration,
                            triggerType: task.triggerType,
                            triggerValue: task.triggerValue,
                            cronExpression: task.cronExpression || '',
                            robotId: task.robotId,
                            robotGroupId: task.robotGroupIds?.[0]
                        });
                    } else {
                        Object.assign(taskForm, {
                            id: null,
                            name: '',
                            type: type,
                            templateId: null,
                            simpleAction: '',
                            formData: {},
                            priority: 2,
                            isGroupTask: false,
                            duration: 30,
                            triggerType: 'scheduled',
                            triggerValue: null,
                            cronExpression: '',
                            robotId: null,
                            robotGroupId: null
                        });
                    }
                    
                    taskDialog.visible = true;
                };
                
                const onTemplateChange = (val) => {
                    const template = templates.value.find(t => t.id === val);
                    if (template) {
                        const formData = {};
                        template.fields.forEach(field => {
                            formData[field.id] = '';
                        });
                        taskForm.formData = formData;
                    }
                };
                
                const renderStepDescription = (description) => {
                    if (!description || !taskForm.templateId) return description;
                    let result = description;
                    Object.entries(taskForm.formData).forEach(([key, value]) => {
                        result = result.replace(new RegExp(`{{${key}}}`, 'g'), value || `[${key}]`);
                    });
                    return result;
                };
                
                const selectLocation = (fieldId) => {
                    ElMessageBox.prompt('请输入位置坐标或选择位置', '位置选择', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputPlaceholder: '如：门诊大厅-A区'
                    }).then(({ value }) => {
                        taskForm.formData[fieldId] = value;
                        ElMessage.success('位置已设置');
                    }).catch(() => {});
                };
                
                const showCronHelp = () => {
                    ElMessageBox.alert(`
                        <div style="font-size: 14px; line-height: 1.6;">
                            <h3 style="margin-top: 0; color: #1890ff;">Cron表达式格式说明</h3>
                            <p>格式：<strong>秒 分 时 日 月 周</strong></p>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px;">
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">字段</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">允许值</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">特殊字符</th>
                                </tr>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">秒</td><td>0-59</td><td>, - * /</td></tr>
                                <tr style="background: #f9f9f9;"><td style="padding: 8px; border: 1px solid #ddd;">分</td><td>0-59</td><td>, - * /</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">时</td><td>0-23</td><td>, - * /</td></tr>
                                <tr style="background: #f9f9f9;"><td style="padding: 8px; border: 1px solid #ddd;">日</td><td>1-31</td><td>, - * ? / L W</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #ddd;">月</td><td>1-12</td><td>, - * /</td></tr>
                                <tr style="background: #f9f9f9;"><td style="padding: 8px; border: 1px solid #ddd;">周</td><td>1-7</td><td>, - * ? / L #</td></tr>
                            </table>
                            
                            <p><strong>常用示例：</strong></p>
                            <ul style="padding-left: 20px; margin: 8px 0;">
                                <li><code>0 0 9 * * ?</code> - 每天9点执行</li>
                                <li><code>0 0/30 9-17 * * ?</code> - 9点到17点每30分钟执行</li>
                                <li><code>0 0 12 ? * MON-FRI</code> - 周一至周五12点执行</li>
                                <li><code>0 0 0 1 * ?</code> - 每月1号0点执行</li>
                                <li><code>0 0 0 ? * SUN</code> - 每周日0点执行</li>
                            </ul>
                        </div>
                    `, 'Cron表达式帮助', {
                        dangerouslyUseHTMLString: true,
                        width: '600px'
                    });
                };
                
                const saveTask = () => {
                    taskFormRef.value.validate((valid) => {
                        if (!valid) return;
                        
                        taskDialog.loading = true;
                        
                        setTimeout(() => {
                            const now = new Date().toLocaleString('zh-CN');
                            const template = taskForm.type === 'process' ? 
                                templates.value.find(t => t.id === taskForm.templateId) : null;
                            
                            if (taskDialog.mode === 'create') {
                                const newId = Math.max(...tasks.value.map(t => t.id), 1000) + 1;
                                
                                let triggerValue = null;
                                if (taskForm.triggerType === 'battery') triggerValue = taskForm.triggerValue || 80;
                                if (taskForm.triggerType === 'idle') triggerValue = taskForm.triggerValue || 30;
                                
                                const newTask = {
                                    id: newId,
                                    name: taskForm.name,
                                    type: taskForm.type,
                                    templateId: taskForm.templateId,
                                    templateName: template ? template.name : (taskForm.simpleAction + '任务'),
                                    status: 'pending',
                                    isRisk: false,
                                    isHighRisk: false,
                                    triggerType: taskForm.triggerType,
                                    triggerValue: triggerValue,
                                    cronExpression: taskForm.triggerType === 'scheduled' ? taskForm.cronExpression : null,
                                    simpleAction: taskForm.type === 'simple' ? taskForm.simpleAction : null,
                                    priority: taskForm.priority,
                                    isGroupTask: taskForm.isGroupTask,
                                    duration: taskForm.duration,
                                    robotId: taskForm.isGroupTask ? null : taskForm.robotId,
                                    robotName: taskForm.isGroupTask ? null : robots.value.find(r => r.id === taskForm.robotId)?.name,
                                    robotStatus: taskForm.isGroupTask ? null : 'online',
                                    robotGroupIds: taskForm.isGroupTask ? [taskForm.robotGroupId] : (template ? template.robotGroupIds : [3]),
                                    formData: { ...taskForm.formData },
                                    steps: template ? JSON.parse(JSON.stringify(template.steps)).map(s => ({
                                        ...s,
                                        status: 'pending',
                                        startTime: null,
                                        endTime: null
                                    })) : generateSimpleSteps(taskForm.simpleAction),
                                    completedSteps: 0,
                                    totalSteps: template ? template.steps.length : 5,
                                    createdTime: now,
                                    updateTime: now,
                                    startTime: getStartTimeText(taskForm),
                                    logs: [{
                                        action: '任务创建',
                                        time: now,
                                        details: `管理员创建了${taskForm.type === 'process' ? '完整流程' : '简单动作'}任务`,
                                        type: 'info'
                                    }]
                                };
                                
                                tasks.value.push(newTask);
                                ElMessage.success('任务创建成功');
                            } else {
                                const index = tasks.value.findIndex(t => t.id === taskForm.id);
                                if (index !== -1) {
                                    const task = tasks.value[index];
                                    task.name = taskForm.name;
                                    task.priority = taskForm.priority;
                                    task.isGroupTask = taskForm.isGroupTask;
                                    task.duration = taskForm.duration;
                                    task.triggerType = taskForm.triggerType;
                                    task.triggerValue = taskForm.triggerType === 'scheduled' ? null : taskForm.triggerValue;
                                    task.cronExpression = taskForm.triggerType === 'scheduled' ? taskForm.cronExpression : null;
                                    task.robotId = taskForm.isGroupTask ? null : taskForm.robotId;
                                    task.robotName = taskForm.isGroupTask ? null : robots.value.find(r => r.id === taskForm.robotId)?.name;
                                    task.formData = { ...taskForm.formData };
                                    task.updateTime = now;
                                    task.startTime = getStartTimeText(taskForm);
                                    task.logs.push({
                                        action: '任务修改',
                                        time: now,
                                        details: '管理员修改了任务信息',
                                        type: 'info'
                                    });
                                    ElMessage.success('任务修改成功');
                                }
                            }
                            
                            taskDialog.loading = false;
                            taskDialog.visible = false;
                        }, 500);
                    });
                };
                
                const generateSimpleSteps = (action) => {
                    const stepsMap = {
                        '清洁': [
                            { name: '任务启动', description: '启动清洁任务', status: 'pending' },
                            { name: '前往清洁区域', description: '导航至清洁区域', status: 'pending' },
                            { name: '执行清洁', description: '执行地面清洁工作', status: 'pending' },
                            { name: '垃圾回收', description: '收集并处理垃圾', status: 'pending' },
                            { name: '任务完成', description: '返回充电站', status: 'pending' }
                        ],
                        '巡检': [
                            { name: '任务启动', description: '启动巡检任务', status: 'pending' },
                            { name: '巡检路线规划', description: '规划巡检路线', status: 'pending' },
                            { name: '执行巡检', description: '按路线执行巡检', status: 'pending' },
                            { name: '异常检测', description: '检测并记录异常情况', status: 'pending' },
                            { name: '任务完成', description: '生成巡检报告', status: 'pending' }
                        ],
                        '配送': [
                            { name: '任务启动', description: '启动配送任务', status: 'pending' },
                            { name: '取货', description: '前往取货点取货', status: 'pending' },
                            { name: '运输', description: '将物品运输至目的地', status: 'pending' },
                            { name: '交货', description: '将物品交给接收人', status: 'pending' },
                            { name: '任务完成', description: '返回基地', status: 'pending' }
                        ],
                        '安防': [
                            { name: '任务启动', description: '启动安防巡逻', status: 'pending' },
                            { name: '巡逻路线', description: '按预设路线巡逻', status: 'pending' },
                            { name: '监控检查', description: '检查监控设备', status: 'pending' },
                            { name: '异常上报', description: '上报安全隐患', status: 'pending' },
                            { name: '任务完成', description: '返回监控室', status: 'pending' }
                        ],
                        '送餐': [
                            { name: '任务启动', description: '启动送餐任务', status: 'pending' },
                            { name: '取餐', description: '前往食堂取餐', status: 'pending' },
                            { name: '配送', description: '将餐食送至指定地点', status: 'pending' },
                            { name: '确认签收', description: '确认用餐人员签收', status: 'pending' },
                            { name: '任务完成', description: '返回基地', status: 'pending' }
                        ]
                    };
                    return stepsMap[action] || stepsMap['清洁'];
                };
                
                const getStartTimeText = (form) => {
                    if (form.triggerType === 'scheduled') {
                        return form.cronExpression ? `定时任务 (${form.cronExpression})` : '立即执行';
                    } else if (form.triggerType === 'battery') {
                        return `电量≥${form.triggerValue || 80}%时触发`;
                    } else if (form.triggerType === 'idle') {
                        return `待机${form.triggerValue || 30}分钟后触发`;
                    }
                    return '';
                };
                
                const getFieldLabel = (fieldId) => {
                    for (const template of templates.value) {
                        const field = template.fields.find(f => f.id === fieldId);
                        if (field) return field.label;
                    }
                    return fieldId;
                };
                
                const editTask = (task) => {
                    if (task.type === 'process') {
                        showTaskDialog('process', task);
                    } else {
                        showTaskDialog('simple', task);
                    }
                };
                
                const deleteTask = (task) => {
                    ElMessageBox.confirm(`确定要删除任务"${task.name}"吗？`, '确认删除', {
                        type: 'warning'
                    }).then(() => {
                        const index = tasks.value.findIndex(t => t.id === task.id);
                        if (index !== -1) {
                            tasks.value.splice(index, 1);
                            ElMessage.success('任务删除成功');
                        }
                    }).catch(() => {});
                };
                
                const schedulingFilter = reactive({ 
                    robotId: '', 
                    status: '',
                    readySortable: false
                });

                const schedulingTable = ref(null);
                let sortableInstance = null;

                // 统计计算属性
                const executingTasks = computed(() => tasks.value.filter(t => t.status === 'executing'));
                const readyTasks = computed(() => tasks.value.filter(t => t.status === 'ready'));
                const pausedTasks = computed(() => tasks.value.filter(t => t.status === 'paused'));

                // 所有任务排序：执行中 > 已暂停 > 准备中 > 未开始
                // 关键修复：准备中任务默认按优先级排序，只有启用拖拽后才按 sortOrder 排序
                const allTasksSorted = computed(() => {
                    let result = [...tasks.value];
                    
                    // 筛选
                    if (schedulingFilter.robotId) {
                        result = result.filter(t => t.robotId == schedulingFilter.robotId);
                    }
                    if (schedulingFilter.status) {
                        result = result.filter(t => t.status === schedulingFilter.status);
                    }
                    
                    // 状态排序优先级
                    const statusOrder = { 
                        'executing': 0,
                        'paused': 1,
                        'ready': 2,
                        'pending': 3,
                        'completed': 4, 
                        'aborted': 5, 
                        'disabled': 6 
                    };
                    
                    result.sort((a, b) => {
                        const orderA = statusOrder[a.status] !== undefined ? statusOrder[a.status] : 7;
                        const orderB = statusOrder[b.status] !== undefined ? statusOrder[b.status] : 7;
                        
                        // 先按状态排序
                        if (orderA !== orderB) {
                            return orderA - orderB;
                        }
                        
                        // 同状态的任务
                        if (a.status === 'ready' && b.status === 'ready') {
                            // 关键修复：只有启用了拖拽排序且任务有 sortOrder 时才按 sortOrder 排序
                            // 否则默认按优先级排序
                            if (schedulingFilter.readySortable && a.sortOrder !== undefined && b.sortOrder !== undefined) {
                                return a.sortOrder - b.sortOrder;
                            }
                            // 默认按优先级排序（高 -> 中 -> 低）
                            return a.priority - b.priority;
                        }
                        
                        // 其他同状态任务按优先级排序
                        return a.priority - b.priority;
                    });
                    
                    return result;
                });

                // 计算准备中任务的索引（用于显示序号）
                const readyTaskIndexMap = computed(() => {
                    const map = new Map();
                    let readyIndex = 0;
                    allTasksSorted.value.forEach((task) => {
                        if (task.status === 'ready') {
                            map.set(task.id, readyIndex);
                            readyIndex++;
                        }
                    });
                    return map;
                });

                // 获取准备中任务的视觉序号（用于显示 1、2、3...）
                const getReadyTaskVisualIndex = (task) => {
                    if (task.status !== 'ready') return -1;
                    return readyTaskIndexMap.value.get(task.id) || 0;
                };

                // 表格行样式
                const schedulingRowClassName = ({ row }) => {
                    if (row.status === 'paused' && row.wasHighRisk) return 'stopped-task-row';
                    return '';
                };

                // 关键修复：正确初始化 Sortable
                const initSortable = () => {
                    // 清理旧实例
                    if (sortableInstance) {
                        try {
                            sortableInstance.destroy();
                        } catch(e) {}
                        sortableInstance = null;
                    }
                    
                    // 检查条件
                    if (!schedulingFilter.robotId || !schedulingFilter.readySortable) {
                        return;
                    }
                    
                    // 获取表格DOM
                    const tableEl = schedulingTable.value?.$el;
                    if (!tableEl) {
                        console.warn('Table element not found');
                        return;
                    }
                    
                    const tbody = tableEl.querySelector('.el-table__body tbody');
                    if (!tbody) {
                        console.warn('Tbody not found');
                        return;
                    }
                    
                    // 关键修复：只在启用拖拽时为当前准备中任务初始化 sortOrder（如果还没有的话）
                    // 但保持默认按优先级排序，除非用户进行了拖拽
                    const visibleTasks = allTasksSorted.value;
                    const readyTasksInView = visibleTasks.filter(t => t.status === 'ready');
                    
                    // 检查是否已经有 sortOrder，如果没有则按当前顺序初始化
                    // 这样首次启用拖拽时会保持当前的优先级排序
                    readyTasksInView.forEach((task, index) => {
                        if (task.sortOrder === undefined) {
                            task.sortOrder = index;
                        }
                    });
                    
                    // 创建 Sortable 实例
                    try {
                        sortableInstance = Sortable.create(tbody, {
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            handle: '.drag-handle', // 只有点击手柄才能拖拽
                            
                            // 关键：filter 用于过滤不可拖拽的行
                            filter: (event, target) => {
                                const row = target.closest('.el-table__row');
                                if (!row) return true;
                                
                                const index = Array.from(tbody.children).indexOf(row);
                                const task = visibleTasks[index];
                                return task && task.status === 'ready' ? false : true;
                            },
                            
                            // 关键：在 onMove 中控制是否可以放置
                            onMove: (evt) => {
                                const relatedRow = evt.related;
                                const relatedIndex = Array.from(tbody.children).indexOf(relatedRow);
                                const relatedTask = visibleTasks[relatedIndex];
                                return relatedTask && relatedTask.status === 'ready';
                            },
                            
                            onEnd: (evt) => {
                                const { oldIndex, newIndex } = evt;
                                
                                if (oldIndex === newIndex) return;
                                
                                const movedTask = visibleTasks[oldIndex];
                                const targetTask = visibleTasks[newIndex];
                                
                                if (!movedTask || movedTask.status !== 'ready' || !targetTask || targetTask.status !== 'ready') {
                                    tableKey.value++; // 强制刷新
                                    return;
                                }
                                
                                // 关键修复：更新 sortOrder 而不是直接操作 DOM
                                const readyTasks = tasks.value.filter(t => 
                                    t.status === 'ready' && 
                                    t.robotId == schedulingFilter.robotId
                                );
                                
                                // 按当前 sortOrder 排序
                                readyTasks.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
                                
                                const movedIndexInReady = readyTasks.findIndex(t => t.id === movedTask.id);
                                const targetIndexInReady = readyTasks.findIndex(t => t.id === targetTask.id);
                                
                                if (movedIndexInReady === -1 || targetIndexInReady === -1) {
                                    tableKey.value++;
                                    return;
                                }
                                
                                // 在准备中任务数组中移动
                                const [removed] = readyTasks.splice(movedIndexInReady, 1);
                                readyTasks.splice(targetIndexInReady, 0, removed);
                                
                                // 重新分配 sortOrder
                                readyTasks.forEach((task, index) => {
                                    task.sortOrder = index;
                                });
                                
                                // 记录日志
                                const now = new Date().toLocaleString('zh-CN');
                                movedTask.updateTime = now;
                                movedTask.logs.push({
                                    action: '调整顺序',
                                    time: now,
                                    details: `从第${movedIndexInReady + 1}位移动到第${targetIndexInReady + 1}位`,
                                    type: 'info'
                                });
                                
                                ElMessage.success(`任务"${movedTask.name}"已移动到第${targetIndexInReady + 1}位`);
                                
                                // 关键修复：递增 tableKey 强制重新渲染，然后在 nextTick 中重新初始化 Sortable
                                tableKey.value++;
                            }
                        });
                        
                        console.log('Sortable initialized successfully');
                    } catch (error) {
                        console.error('Failed to initialize Sortable:', error);
                    }
                };

                // 关键修复：监听 tableKey 变化，在表格重新渲染后重新初始化 Sortable
                watch(tableKey, () => {
                    if (schedulingFilter.readySortable && schedulingFilter.robotId) {
                        nextTick(() => {
                            setTimeout(() => {
                                initSortable();
                            }, 100);
                        });
                    }
                });

                // 机器人筛选变化时
                const onRobotFilterChange = () => {
                    // 清除 sortOrder，让任务恢复默认的优先级排序
                    tasks.value.forEach(t => {
                        if (t.status === 'ready') {
                            delete t.sortOrder;
                        }
                    });
                    
                    schedulingFilter.readySortable = false;
                    if (sortableInstance) {
                        try {
                            sortableInstance.destroy();
                        } catch(e) {}
                        sortableInstance = null;
                    }
                    
                    // 强制重新渲染表格
                    tableKey.value++;
                };

                // 拖拽开关变化
                const onSortableChange = (val) => {
                    if (val) {
                        // 启用拖拽时初始化
                        nextTick(() => {
                            setTimeout(() => {
                                initSortable();
                            }, 200);
                        });
                    } else {
                        // 关闭拖拽时清理
                        if (sortableInstance) {
                            try {
                                sortableInstance.destroy();
                            } catch(e) {}
                            sortableInstance = null;
                        }
                        // 可选：清除 sortOrder 恢复默认排序
                        // tasks.value.forEach(t => {
                        //     if (t.status === 'ready') delete t.sortOrder;
                        // });
                        tableKey.value++;
                    }
                };

                // 监听页面切换
                watch(() => activeNav.value, (val) => {
                    if (val !== 'scheduling' && sortableInstance) {
                        try {
                            sortableInstance.destroy();
                        } catch(e) {}
                        sortableInstance = null;
                    }
                });

                const refreshTasks = () => {
                    ElMessage.success('任务列表已刷新');
                    if (schedulingFilter.readySortable && schedulingFilter.robotId) {
                        tableKey.value++; // 强制刷新并重新初始化
                    }
                };

               

                const pauseTask = (task) => {
                    ElMessageBox.confirm('确定要暂停该任务吗？暂停后其他待执行任务可以执行。', '确认暂停', {
                        type: 'warning'
                    }).then(() => {
                        task.status = 'paused';
                        delete task.sortOrder; // 清除排序
                        task.updateTime = new Date().toLocaleString('zh-CN');
                        task.logs.push({
                            action: '任务暂停',
                            time: task.updateTime,
                            details: '管理员暂停了任务',
                            type: 'warning'
                        });
                        ElMessage.success('任务已暂停');
                        tableKey.value++; // 强制刷新
                    }).catch(() => {});
                };

                const canResume = (task) => {
                    const executing = tasks.value.filter(t => 
                        t.id !== task.id && 
                        t.status === 'executing' && 
                        t.robotId === task.robotId
                    );
                    return executing.length === 0;
                };

                const resumeTask = (task) => {
                    if (!canResume(task)) {
                        ElMessage.error('该机器人有正在执行的任务，无法继续');
                        return;
                    }
                    ElMessageBox.confirm('确定要继续执行该任务吗？', '确认继续').then(() => {
                        task.status = 'executing';
                        delete task.sortOrder; // 清除排序
                        task.updateTime = new Date().toLocaleString('zh-CN');
                        task.logs.push({
                            action: '任务继续',
                            time: task.updateTime,
                            details: '管理员继续执行任务',
                            type: 'success'
                        });
                        ElMessage.success('任务已继续执行');
                        tableKey.value++; // 强制刷新
                    }).catch(() => {});
                };

                const disableTask = (task) => {
                    ElMessageBox.confirm('禁用后任务将不会进入准备队列，确定要禁用吗？', '确认禁用', {
                        type: 'warning'
                    }).then(() => {
                        task.status = 'disabled';
                        delete task.sortOrder;
                        task.updateTime = new Date().toLocaleString('zh-CN');
                        task.logs.push({
                            action: '任务禁用',
                            time: task.updateTime,
                            details: '管理员禁用了任务',
                            type: 'warning'
                        });
                        ElMessage.success('任务已禁用');
                        tableKey.value++; // 强制刷新
                    }).catch(() => {});
                };

                const enableTask = (task) => {
                    task.status = 'pending';
                    task.updateTime = new Date().toLocaleString('zh-CN');
                    task.logs.push({
                        action: '任务启用',
                        time: task.updateTime,
                        details: '管理员启用了任务',
                        type: 'success'
                    });
                    ElMessage.success('任务已启用');
                    tableKey.value++; // 强制刷新
                };

                const stopTask = (task) => {
                    ElMessageBox.confirm('停止后任务将重置为未开始状态，需要再次触发才能执行，确定要停止吗？', '确认停止', {
                        type: 'warning'
                    }).then(() => {
                        task.status = 'pending';
                        delete task.sortOrder;
                        task.completedSteps = 0;
                        if (task.steps) {
                            task.steps.forEach(s => {
                                s.status = 'pending';
                                s.startTime = null;
                                s.endTime = null;
                            });
                        }
                        task.updateTime = new Date().toLocaleString('zh-CN');
                        task.logs.push({
                            action: '任务停止',
                            time: task.updateTime,
                            details: '管理员停止了任务，进度已重置',
                            type: 'warning'
                        });
                        ElMessage.success('任务已停止');
                        tableKey.value++; // 强制刷新
                    }).catch(() => {});
                };

                const cancelTask = (task) => {
                    ElMessageBox.confirm(`确定要取消任务"${task.name}"的准备状态吗？任务将变为未开始。`, '确认取消', {
                        type: 'warning'
                    }).then(() => {
                        task.status = 'pending';
                        delete task.sortOrder;
                        task.updateTime = new Date().toLocaleString('zh-CN');
                        task.logs.push({
                            action: '任务取消',
                            time: task.updateTime,
                            details: '管理员取消了任务准备状态',
                            type: 'warning'
                        });
                        ElMessage.success('任务已取消，变为未开始状态');
                        tableKey.value++; // 强制刷新
                    }).catch(() => {});
                };
                
                // ==================== 异常处理 ====================
                const highRiskTasks = computed(() => tasks.value.filter(t => t.isHighRisk));
                const riskTasks = computed(() => tasks.value.filter(t => t.isRisk && !t.isHighRisk));
                const abnormalRobots = computed(() => robots.value.filter(r => 
                    r.status === 'offline' || r.status === 'fault' || r.status === 'low_battery'
                ));
                const abnormalRobotCount = computed(() => abnormalRobots.value.length);
                const resolvedToday = ref(3);
                
                const abnormalFilter = reactive({ level: '', robotId: '' });
                
                const filteredAbnormalTasks = computed(() => {
                    let result = tasks.value.filter(t => t.isRisk || t.isHighRisk);
                    
                    if (abnormalFilter.level === 'high') {
                        result = result.filter(t => t.isHighRisk);
                    } else if (abnormalFilter.level === 'normal') {
                        result = result.filter(t => t.isRisk && !t.isHighRisk);
                    }
                    
                    if (abnormalFilter.robotId) {
                        result = result.filter(t => t.robotId == abnormalFilter.robotId);
                    }
                    
                    result = [...result].sort((a, b) => {
                        if (a.isHighRisk && !b.isHighRisk) return -1;
                        if (!a.isHighRisk && b.isHighRisk) return 1;
                        return new Date(b.updateTime) - new Date(a.updateTime);
                    });
                    
                    return result;
                });
                
                const resetAbnormalFilter = () => {
                    abnormalFilter.level = '';
                    abnormalFilter.robotId = '';
                };
                
                const tableRowClassName = ({ row }) => {
                    if (row.isHighRisk) return 'abnormal-task-row';
                    return '';
                };
                
                const resolveRisk = (task) => {
                    ElMessageBox.confirm('确定要将此任务标记为已解决吗？', '确认解决', {
                        type: 'success'
                    }).then(() => {
                        task.isRisk = false;
                        task.updateTime = new Date().toLocaleString('zh-CN');
                        task.logs.push({
                            action: '风险解除',
                            time: task.updateTime,
                            details: '管理员标记风险已解除',
                            type: 'success'
                        });
                        ElMessage.success('风险已标记为已解决');
                        resolvedToday.value++;
                    }).catch(() => {});
                };
                
                // ==================== 异常响应 ====================
                const reassignDialog = reactive({
                    visible: false,
                    task: null,
                    selectedRobotId: null
                });
                
                const availableRobotsForReassign = computed(() => {
                    if (!reassignDialog.task) return [];
                    return robots.value.filter(r => 
                        reassignDialog.task.robotGroupIds.includes(r.groupId) && 
                        r.status === 'online' && 
                        r.battery > 20 &&
                        r.id !== reassignDialog.task.robotId
                    );
                });
                
                const showReassignDialog = (task) => {
                    reassignDialog.task = task;
                    reassignDialog.selectedRobotId = null;
                    reassignDialog.visible = true;
                };
                
                const confirmReassign = () => {
                    if (!reassignDialog.selectedRobotId) return;
                    
                    const robot = robots.value.find(r => r.id === reassignDialog.selectedRobotId);
                    const task = reassignDialog.task;
                    const now = new Date().toLocaleString('zh-CN');
                    
                    task.robotId = robot.id;
                    task.robotName = robot.name;
                    task.robotStatus = robot.status;
                    
                    if (task.isHighRisk && task.status === 'executing') {
                        task.status = 'ready';
                        task.isHighRisk = false;
                        task.isRisk = false;
                        task.logs.push({
                            action: '任务重新分配',
                            time: now,
                            details: `任务从${task.robotName}重新分配给${robot.name}，进入准备队列`,
                            type: 'success'
                        });
                    } else {
                        task.isRisk = false;
                        task.isHighRisk = false;
                        task.logs.push({
                            action: '任务重新分配',
                            time: now,
                            details: `任务重新分配给${robot.name}`,
                            type: 'success'
                        });
                    }
                    
                    task.updateTime = now;
                    ElMessage.success('任务重新分配成功');
                    reassignDialog.visible = false;
                    resolvedToday.value++;
                    tableKey.value++; // 强制刷新
                };
                
                const terminateTask = (task) => {
                    ElMessageBox.prompt('请输入终止原因', '终止任务', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputPlaceholder: '请输入终止原因',
                        inputValidator: (value) => {
                            if (!value || value.trim() === '') return '终止原因不能为空';
                            return true;
                        }
                    }).then(({ value }) => {
                        const now = new Date().toLocaleString('zh-CN');
                        task.status = 'aborted';
                        task.isRisk = false;
                        task.isHighRisk = false;
                        task.updateTime = now;
                        task.logs.push({
                            action: '任务终止',
                            time: now,
                            details: `管理员终止了任务，原因：${value}`,
                            type: 'danger'
                        });
                        ElMessage.success('任务已终止');
                        resolvedToday.value++;
                        tableKey.value++; // 强制刷新
                    }).catch(() => {});
                };
                
                const abortHighRiskTask = (task) => {
                    ElMessageBox.confirm('确定要中止该高风险任务吗？任务将暂停并保存进度，之后可选择重新分配或恢复。', '确认中止', {
                        type: 'warning'
                    }).then(() => {
                        task.status = 'paused';
                        task.wasHighRisk = true;
                        task.updateTime = new Date().toLocaleString('zh-CN');
                        task.logs.push({
                            action: '任务中止',
                            time: task.updateTime,
                            details: '管理员中止了高风险任务，进度已保存',
                            type: 'warning'
                        });
                        ElMessage.success('任务已中止，请重新分配或恢复');
                        tableKey.value++; // 强制刷新
                    }).catch(() => {});
                };
                
                const recoverTask = (task) => {
                    const robot = robots.value.find(r => r.id === task.robotId);
                    if (robot && robot.status === 'online' && robot.battery > 20) {
                        if (task.wasHighRisk) {
                            task.status = 'ready';
                            task.wasHighRisk = false;
                            task.isHighRisk = false;
                            task.isRisk = false;
                            task.logs.push({
                                action: '任务恢复',
                                time: new Date().toLocaleString('zh-CN'),
                                details: '机器人状态已恢复，任务进入准备队列',
                                type: 'success'
                            });
                            ElMessage.success('任务已恢复，进入准备队列');
                        } else {
                            if (task.status === 'pending') {
                                task.status = 'ready';
                            }
                            task.isRisk = false;
                            task.logs.push({
                                action: '任务恢复',
                                time: new Date().toLocaleString('zh-CN'),
                                details: '机器人状态已恢复，任务继续执行',
                                type: 'success'
                            });
                            ElMessage.success('任务已恢复');
                        }
                        resolvedToday.value++;
                        tableKey.value++; // 强制刷新
                    } else {
                        const availableRobots = robots.value.filter(r => 
                            task.robotGroupIds.includes(r.groupId) && 
                            r.status === 'online' && 
                            r.battery > 20
                        );
                        
                        if (availableRobots.length === 0) {
                            ElMessage.warning('原机器人未恢复，且暂无可用的替代机器人');
                            return;
                        }
                        
                        ElMessageBox.confirm(
                            `原机器人${robot?.name || ''}状态未恢复，是否自动分配到可用机器人${availableRobots[0].name}？`,
                            '恢复任务',
                            {
                                confirmButtonText: '自动分配',
                                cancelButtonText: '手动选择',
                                type: 'info'
                            }
                        ).then(() => {
                            const newRobot = availableRobots[0];
                            task.robotId = newRobot.id;
                            task.robotName = newRobot.name;
                            task.robotStatus = newRobot.status;
                            if (task.wasHighRisk) {
                                task.status = 'ready';
                                task.wasHighRisk = false;
                            } else if (task.status === 'pending') {
                                task.status = 'ready';
                            }
                            task.isHighRisk = false;
                            task.isRisk = false;
                            task.logs.push({
                                action: '任务恢复',
                                time: new Date().toLocaleString('zh-CN'),
                                details: `任务自动分配给${newRobot.name}`,
                                type: 'success'
                            });
                            ElMessage.success(`任务已恢复并分配给${newRobot.name}`);
                            resolvedToday.value++;
                            tableKey.value++; // 强制刷新
                        }).catch(() => {
                            showReassignDialog(task);
                        });
                    }
                };
                
                // ==================== 详情对话框 ====================
                const detailDialog = reactive({ visible: false });
                const currentTask = ref(null);
                
                const viewTaskDetail = (task) => {
                    currentTask.value = task;
                    detailDialog.visible = true;
                };
                
                return {
                    // 基础
                    activeNav,
                    expandedMenu,
                    getPageTitle,
                    toggleMenu,
                    switchNav,
                    tableKey, // 关键：暴露 tableKey
                    
                    // 数据
                    robotGroups,
                    robots,
                    templates,
                    tasks,
                    getRobotGroupName,
                    getRobotGroupNames,
                    getRobotLocation,
                    getStatusText,
                    getTriggerTypeText,
                    getTriggerTypeTag,
                    getStepStatusText,
                    
                    // 模板管理
                    templateFilter,
                    filteredTemplates,
                    filterTemplates,
                    resetTemplateFilter,
                    templateDialog,
                    templateForm,
                    showTemplateDialog,
                    addField,
                    removeField,
                    addStep,
                    removeStep,
                    saveTemplate,
                    viewTemplate,
                    deleteTemplate,
                    
                    // 任务管理
                    taskFilter,
                    filteredTasks,
                    filterTasks,
                    resetTaskFilter,
                    canEdit,
                    canDelete,
                    taskDialog,
                    taskFormRef,
                    taskForm,
                    taskRules,
                    currentTemplate,
                    simpleActions,
                    availableRobots,
                    showTaskDialog,
                    onTemplateChange,
                    renderStepDescription,
                    selectLocation,
                    showCronHelp,
                    saveTask,
                    getFieldLabel,
                    editTask,
                    deleteTask,
                    
                    // 计划管理 - 修复后
                    schedulingFilter,
                    schedulingTable,
                    executingTasks,
                    readyTasks,
                    pausedTasks,
                    allTasksSorted,
                    getReadyTaskVisualIndex, // 使用新的计算方法
                    schedulingRowClassName,
                    onRobotFilterChange,
                    onSortableChange,
                    refreshTasks,
                    pauseTask,
                    canResume,
                    resumeTask,
                    disableTask,
                    enableTask,
                    stopTask,
                    cancelTask,
                    queuePositionKey,
                    
                    // 异常处理
                    highRiskTasks,
                    riskTasks,
                    abnormalRobots,
                    abnormalRobotCount,
                    resolvedToday,
                    abnormalFilter,
                    filteredAbnormalTasks,
                    resetAbnormalFilter,
                    tableRowClassName,
                    resolveRisk,
                    abortHighRiskTask,
                    recoverTask,
                    
                    // 异常响应
                    reassignDialog,
                    availableRobotsForReassign,
                    showReassignDialog,
                    confirmReassign,
                    terminateTask,
                    
                    // 详情
                    detailDialog,
                    currentTask,
                    viewTaskDetail
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>

</html>

